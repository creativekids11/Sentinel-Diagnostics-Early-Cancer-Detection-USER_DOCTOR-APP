{% extends "layouts/base.html" %} {% block title %}Sign Up{% endblock %} {%
block head %}
<style>
	body {
		justify-content: center;
		align-items: center;
		padding: 20px;
	}
	.card-wrap {
		width: 100%;
		max-width: 950px;
		max-height: 95vh;
		overflow-y: auto;
		display: grid;
		grid-template-columns: 1fr 1fr;
		background-color: #1e1e2f;
		border-radius: 20px;
		box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
	}
	.panel-left,
	.panel-right {
		padding: 40px;
		display: flex;
		flex-direction: column;
		justify-content: center;
	}
	.panel-left {
		background-color: #191a2d;
	}
	.panel-right {
		background: url("{{ url_for('static', filename='assets/linescircles2.png') }}")
			no-repeat center center;
		background-size: cover;
		color: white;
	}
	.panel-right h1 {
		font-size: 36px;
		margin-bottom: 20px;
	}
	.panel-right p {
		font-size: 16px;
		color: #ccc;
	}
	form {
		display: flex;
		flex-direction: column;
		gap: 16px;
	}
	.input-group {
		display: flex;
		background: #3a3b50;
		border-radius: 25px;
		padding: 14px 20px;
		color: #ccc;
		position: relative;
	}
	.input-group.error {
		border: 2px solid #ff4757;
	}
	.input-group.success {
		border: 2px solid #2ed573;
	}
	.input-group input,
	.input-group select {
		background: transparent;
		border: none;
		outline: none;
		color: white;
		font-size: 14px;
		width: 100%;
	}
	.input-group select option {
		background-color: #3a3b50;
		color: white;
	}
	.btn {
		background: linear-gradient(to right, #ff416c, #9b42f4);
		color: white;
		border: none;
		padding: 14px;
		border-radius: 25px;
		font-weight: bold;
		font-size: 14px;
		cursor: pointer;
		transition: opacity 0.3s;
	}
	.btn:hover {
		opacity: 0.9;
	}
	.btn:disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}
	.hint {
		margin-top: 10px;
		font-size: 13px;
		color: #aaa;
	}
	.hint a {
		color: #9b42f4;
		text-decoration: none;
	}
	.error-message {
		color: #ff4757;
		font-size: 12px;
		margin-top: 5px;
		display: none;
	}
	.success-message {
		color: #2ed573;
		font-size: 12px;
		margin-top: 5px;
		display: none;
	}
	.password-strength {
		margin-top: 5px;
	}
	.password-strength-bar {
		width: 100%;
		height: 6px;
		background-color: #444;
		border-radius: 3px;
		overflow: hidden;
	}
	.password-strength-fill {
		height: 100%;
		transition: width 0.3s ease, background-color 0.3s ease;
		width: 0%;
	}
	.password-strength-text {
		font-size: 12px;
		margin-top: 2px;
	}
	.validation-icon {
		position: absolute;
		right: 15px;
		top: 50%;
		transform: translateY(-50%);
		display: none;
	}
	@media (max-width: 900px) {
		.card-wrap {
			grid-template-columns: 1fr;
		}
		.panel-right {
			display: none;
		}
	}
	.google-button {
		background: white;
		color: #4285f4;
		border: 2px solid #4285f4;
		padding: 14px;
		border-radius: 25px;
		font-weight: bold;
		font-size: 14px;
		cursor: pointer;
		transition: all 0.3s;
		margin-top: 15px;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 10px;
	}
	.google-button:hover {
		background: #4285f4;
		color: white;
	}
	.divider {
		text-align: center;
		margin: 15px 0;
		position: relative;
		color: #aaa;
		font-size: 14px;
	}
	.divider::before {
		content: "";
		position: absolute;
		top: 50%;
		left: 0;
		right: 0;
		height: 1px;
		background: #444;
	}
	.divider span {
		background: #191a2d;
		padding: 0 15px;
	}
</style>
{% endblock %} {% block body %}
<div class="card-wrap">
	<div class="panel-left">
		<h2 style="color: #dcdcdc; margin-bottom: 30px; text-align: center">
			CREATE NEW ACCOUNT
		</h2>
		{% with messages = get_flashed_messages(with_categories=true) %} {% if
		messages %}
		<ul class="flash-messages">
			{% for category, msg in messages %}
			<li class="flash-{{category}}">{{ msg }}</li>
			{% endfor %}
		</ul>
		{% endif %} {% endwith %}
		<form
			id="signupForm"
			method="post"
			action="{{ url_for('signup_page') }}"
			enctype="multipart/form-data">
			<div class="input-group" id="fullnameGroup">
				<input
					name="fullname"
					id="fullname"
					type="text"
					placeholder="Full name"
					required />
				<span class="validation-icon" id="fullnameIcon">✓</span>
			</div>
			<div class="error-message" id="fullnameError"></div>

			<div class="input-group" id="usernameGroup">
				<input
					name="username"
					id="username"
					type="text"
					placeholder="Username"
					required />
				<span class="validation-icon" id="usernameIcon">✓</span>
			</div>
			<div class="error-message" id="usernameError"></div>
			<div class="success-message" id="usernameSuccess"></div>

			<div class="input-group" id="emailGroup">
				<input
					name="email"
					id="email"
					type="email"
					placeholder="Email Address"
					required />
				<span class="validation-icon" id="emailIcon">✓</span>
			</div>
			<div class="error-message" id="emailError"></div>

			<div class="input-group" id="phoneGroup">
				<input
					name="phone"
					id="phone"
					type="tel"
					placeholder="Phone Number"
					required />
				<span class="validation-icon" id="phoneIcon">✓</span>
			</div>
			<div class="error-message" id="phoneError"></div>

			<div class="input-group" id="passwordGroup">
				<input
					name="password"
					id="password"
					type="password"
					placeholder="Password"
					required />
				<span class="validation-icon" id="passwordIcon">✓</span>
			</div>
			<div class="password-strength" id="passwordStrength">
				<div class="password-strength-bar">
					<div class="password-strength-fill" id="passwordStrengthFill"></div>
				</div>
				<div class="password-strength-text" id="passwordStrengthText"></div>
			</div>
			<div class="error-message" id="passwordError"></div>

			<div class="input-group" id="confirmGroup">
				<input
					name="confirm"
					id="confirm"
					type="password"
					placeholder="Confirm Password"
					required />
				<span class="validation-icon" id="confirmIcon">✓</span>
			</div>
			<div class="show_password">
				<input
					type="checkbox"
					name="Show Password"
					id="show_password"
					onclick="
				const password = document.getElementById('password');
				const confirmPassword = document.getElementById('confirm');
				[password, confirmPassword].forEach(
  input => input.type = input.type === 'password' ? 'text' : 'password'
);

				" />
				<label for="show_password" style="color: #aaa; font-size: 14px"
					>Show Password</label
				>
			</div>
			<div class="error-message" id="confirmError"></div>

			<div class="input-group">
				<select name="role" id="roleSelect" required>
					<option value="">-- Select Role --</option>
					<option value="patient">Patient</option>
					<option value="doctor">Doctor</option>
				</select>
			</div>
			<div
				class="input-group"
				id="qualificationsContainer"
				style="display: none">
				<input
					type="text"
					name="qualifications"
					id="qualificationsInput"
					placeholder="Qualifications (e.g., MD, Oncologist)" />
			</div>
			<label
				class="input-group"
				id="qualificationPdfContainer"
				style="display: none; cursor: pointer">
				<input
					id="qualificationPdfInput"
					name="qualification_pdf"
					type="file"
					accept=".pdf"
					style="display: none" />
				<span id="qualificationPdfLabel">Upload Qualification PDF</span>
				<div
					id="qualificationPdfPreview"
					style="display: none; margin-top: 8px">
					<div
						id="qualificationPdfPreviewText"
						style="font-size: 12px; color: #9b9db3; margin-top: 6px">
						File selected
					</div>
				</div>
			</label>
			<label class="input-group" style="cursor: pointer">
				<input
					id="pancardInput"
					name="pancard_file"
					type="file"
					accept=".pdf,.jpg,.jpeg,.png"
					style="display: none" />
				<span id="pancardLabel">Upload PAN Card (PDF/Image) - Optional</span>
				<div id="pancardPreview" style="display: none; margin-top: 8px">
					<img
						id="pancardPreviewImg"
						src=""
						alt="PAN Preview"
						style="
							max-width: 100%;
							max-height: 180px;
							border-radius: 8px;
							display: block;
							margin-top: 8px;
						" />
					<div
						id="pancardPreviewText"
						style="font-size: 12px; color: #9b9db3; margin-top: 6px">
						File selected
					</div>
				</div>
			</label>
			<label class="input-group" style="cursor: pointer">
				<input
					id="photoUpload"
					name="photo"
					type="file"
					accept="image/*"
					style="display: none" />
				<span id="photoLabel">Upload Profile Photo (Optional)</span>
				<div id="photoPreview" style="display: none; margin-top: 8px">
					<img
						id="photoPreviewImg"
						src=""
						alt="Photo Preview"
						style="
							width: 96px;
							height: 96px;
							object-fit: cover;
							border-radius: 50%;
							display: block;
						" />
					<div
						id="photoPreviewText"
						style="font-size: 12px; color: #9b9db3; margin-top: 6px">
						Photo selected
					</div>
				</div>
			</label>
			<button type="submit" id="submitBtn" class="btn">SIGN UP</button>

			<div class="divider">
				<span>OR</span>
			</div>

			<button type="button" class="google-button" id="googleSignUpBtn">
				<svg width="20" height="20" viewBox="0 0 24 24">
					<path
						fill="#4285f4"
						d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
					<path
						fill="#34a853"
						d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
					<path
						fill="#fbbc05"
						d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
					<path
						fill="#ea4335"
						d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
				</svg>
				Continue with Google
			</button>

			<div class="hint">
				Already have an account?
				<a href="{{ url_for('login_page') }}">Log in</a>
			</div>
		</form>

		<!-- Google OAuth Modal for Role Selection -->
		<div
			id="googleRoleModal"
			style="
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(0, 0, 0, 0.8);
				z-index: 1000;
				justify-content: center;
				align-items: center;
			">
			<div
				style="
					background: #1e1e2f;
					padding: 40px;
					border-radius: 20px;
					max-width: 400px;
					width: 90%;
				">
				<h3 style="color: #dcdcdc; text-align: center; margin-bottom: 20px">
					Select Your Role
				</h3>
				<p
					style="
						color: #aaa;
						text-align: center;
						margin-bottom: 30px;
						font-size: 14px;
					">
					Choose how you want to use Sentinel Diagnostics
				</p>

				<button
					type="button"
					class="btn"
					onclick="completeGoogleSignup('patient')"
					style="width: 100%; margin-bottom: 15px">
					👤 Continue as Patient
				</button>

				<button
					type="button"
					class="btn"
					onclick="completeGoogleSignup('doctor')"
					style="width: 100%; margin-bottom: 20px">
					🩺 Continue as Doctor
				</button>

				<button
					type="button"
					onclick="closeGoogleModal()"
					style="
						background: transparent;
						border: 1px solid #444;
						color: #aaa;
						padding: 10px;
						border-radius: 15px;
						width: 100%;
						cursor: pointer;
					">
					Cancel
				</button>
			</div>
		</div>
	</div>
	<div class="panel-right">
		<img
			src="{{ url_for('static', filename='assets/logo.png') }}"
			alt="Logo"
			style="
				height: 100px;
				width: 290px;
				margin-bottom: 10px;
				position: relative;
				top: -200px;
				align-self: center;
			" />
		<h1 style="text-align: center">Join Our Platform Today</h1>
		<p style="text-align: center">
			Create your account for cutting-edge cancer detection and rapid healing
			support.
		</p>
	</div>
</div>

<script>
	// Form validation state
	const validationState = {
		fullname: false,
		username: false,
		email: false,
		phone: false,
		password: false,
		confirm: false,
	};

	// Debounce function for API calls
	function debounce(func, wait) {
		let timeout;
		return function executedFunction(...args) {
			const later = () => {
				clearTimeout(timeout);
				func(...args);
			};
			clearTimeout(timeout);
			timeout = setTimeout(later, wait);
		};
	}

	// Show validation state
	function showValidation(fieldName, isValid, message = "") {
		const group = document.getElementById(fieldName + "Group");
		const icon = document.getElementById(fieldName + "Icon");
		const errorDiv = document.getElementById(fieldName + "Error");
		const successDiv = document.getElementById(fieldName + "Success");

		group.classList.remove("error", "success");
		icon.style.display = "none";
		if (errorDiv) {
			errorDiv.style.display = "none";
			errorDiv.textContent = "";
		}
		if (successDiv) {
			successDiv.style.display = "none";
			successDiv.textContent = "";
		}

		if (isValid) {
			group.classList.add("success");
			icon.style.display = "block";
			icon.style.color = "#2ed573";
			icon.textContent = "✓";
			if (successDiv && message) {
				successDiv.style.display = "block";
				successDiv.textContent = message;
			}
		} else if (message) {
			group.classList.add("error");
			icon.style.display = "block";
			icon.style.color = "#ff4757";
			icon.textContent = "✗";
			if (errorDiv) {
				errorDiv.style.display = "block";
				errorDiv.textContent = message;
			}
		}

		validationState[fieldName] = isValid;
		updateSubmitButton();
	}

	// Update submit button state
	function updateSubmitButton() {
		const submitBtn = document.getElementById("submitBtn");
		const allValid = Object.values(validationState).every((v) => v);
		submitBtn.disabled = !allValid;
	}

	// Validate full name
	function validateFullName() {
		const fullname = document.getElementById("fullname").value.trim();
		if (!fullname) {
			showValidation("fullname", false, "");
			return;
		}

		const words = fullname.split(/\s+/);
		if (words.length < 2) {
			showValidation(
				"fullname",
				false,
				"Full name must contain at least first and last name"
			);
			return;
		}

		if (words.some((word) => word.length < 2)) {
			showValidation(
				"fullname",
				false,
				"Each part of the name must be at least 2 characters"
			);
			return;
		}

		if (!/^[a-zA-Z\s]+$/.test(fullname)) {
			showValidation(
				"fullname",
				false,
				"Full name can only contain letters and spaces"
			);
			return;
		}

		showValidation("fullname", true);
	}

	// Validate username
	const validateUsername = debounce(async function () {
		const username = document.getElementById("username").value.trim();
		if (!username) {
			showValidation("username", false, "");
			return;
		}

		// Client-side validation first
		if (username.length < 3) {
			showValidation(
				"username",
				false,
				"Username must be at least 3 characters long"
			);
			return;
		}

		if (!/^[a-zA-Z][a-zA-Z0-9_-]*$/.test(username)) {
			showValidation(
				"username",
				false,
				"Username must start with a letter and can only contain letters, numbers, underscore, and hyphen"
			);
			return;
		}

		// Check for restricted characters
		const restrictedChars = [",", "'", '"', "/", "\\", "*"];
		for (const char of restrictedChars) {
			if (username.includes(char)) {
				showValidation(
					"username",
					false,
					`Username cannot contain the character: ${char}`
				);
				return;
			}
		}

		// Server-side validation
		try {
			const response = await fetch("/api/check-username", {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
				},
				body: JSON.stringify({ username: username }),
			});

			const data = await response.json();
			if (data.is_valid) {
				showValidation("username", true, "Username is available");
			} else {
				showValidation(
					"username",
					false,
					data.errors[0] || "Username validation failed"
				);
			}
		} catch (error) {
			console.error("Username validation error:", error);
		}
	}, 500);

	// Validate email
	function validateEmail() {
		const email = document.getElementById("email").value.trim();
		if (!email) {
			showValidation("email", false, "");
			return;
		}

		const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
		if (!emailRegex.test(email)) {
			showValidation("email", false, "Please enter a valid email address");
			return;
		}

		showValidation("email", true);
	}

	// Validate phone
	function validatePhone() {
		const phone = document.getElementById("phone").value.trim();
		if (!phone) {
			showValidation("phone", false, "");
			return;
		}

		const cleanPhone = phone.replace(/[^\d+]/g, "");
		let phoneDigits = cleanPhone;

		if (phoneDigits.startsWith("+91")) {
			phoneDigits = phoneDigits.substring(3);
		} else if (phoneDigits.startsWith("91") && phoneDigits.length === 12) {
			phoneDigits = phoneDigits.substring(2);
		}

		if (!/^\d{10}$/.test(phoneDigits)) {
			showValidation(
				"phone",
				false,
				"Phone number must be a valid 10-digit Indian mobile number"
			);
			return;
		}

		if (!"6789".includes(phoneDigits[0])) {
			showValidation(
				"phone",
				false,
				"Phone number must start with 6, 7, 8, or 9"
			);
			return;
		}

		showValidation("phone", true);
	}

	// Validate password strength
	const validatePassword = debounce(async function () {
		const password = document.getElementById("password").value;
		if (!password) {
			showValidation("password", false, "");
			document.getElementById("passwordStrength").style.display = "none";
			return;
		}

		document.getElementById("passwordStrength").style.display = "block";

		try {
			const response = await fetch("/api/check-password-strength", {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
				},
				body: JSON.stringify({ password: password }),
			});

			const data = await response.json();

			// Update strength bar
			const fillBar = document.getElementById("passwordStrengthFill");
			const strengthText = document.getElementById("passwordStrengthText");

			fillBar.style.width = data.score + "%";
			fillBar.style.backgroundColor = data.strength_color;
			strengthText.textContent = `${data.strength_level} (${data.score}%)`;
			strengthText.style.color = data.strength_color;

			if (data.is_valid) {
				showValidation("password", true);
			} else {
				showValidation(
					"password",
					false,
					data.errors[0] || "Password does not meet requirements"
				);
			}
		} catch (error) {
			console.error("Password validation error:", error);
		}
	}, 300);

	// Validate password confirmation
	function validateConfirm() {
		const password = document.getElementById("password").value;
		const confirm = document.getElementById("confirm").value;

		if (!confirm) {
			showValidation("confirm", false, "");
			return;
		}

		if (password !== confirm) {
			showValidation("confirm", false, "Passwords do not match");
			return;
		}

		showValidation("confirm", true);
	}

	// Event listeners
	document
		.getElementById("fullname")
		.addEventListener("input", validateFullName);
	document
		.getElementById("username")
		.addEventListener("input", validateUsername);
	document.getElementById("email").addEventListener("input", validateEmail);
	document.getElementById("phone").addEventListener("input", validatePhone);
	document
		.getElementById("password")
		.addEventListener("input", validatePassword);
	document.getElementById("confirm").addEventListener("input", validateConfirm);

	// Role selection handler
	document
		.getElementById("roleSelect")
		.addEventListener("change", function (e) {
			const isDoctor = e.target.value === "doctor";
			const qualificationsContainer = document.getElementById(
				"qualificationsContainer"
			);
			const qualificationPdfContainer = document.getElementById(
				"qualificationPdfContainer"
			);
			const qualificationsInput = document.getElementById(
				"qualificationsInput"
			);
			const qualificationPdfInput = document.getElementById(
				"qualificationPdfInput"
			);

			// Show/hide containers
			qualificationsContainer.style.display = isDoctor ? "flex" : "none";
			qualificationPdfContainer.style.display = isDoctor ? "flex" : "none";

			// Add/remove required attribute based on role
			if (isDoctor) {
				qualificationsInput.setAttribute("required", "");
				qualificationPdfInput.setAttribute("required", "");
			} else {
				qualificationsInput.removeAttribute("required");
				qualificationPdfInput.removeAttribute("required");
			}
		});

	// Form submission handler
	document
		.getElementById("signupForm")
		.addEventListener("submit", function (e) {
			const allValid = Object.values(validationState).every((v) => v);
			if (!allValid) {
				e.preventDefault();
				notifications.error(
					"Please fix the validation errors before submitting."
				);
			}
		});

	// Initialize validation state
	updateSubmitButton();

	// Image preview helpers
	function readFileAsDataURL(file) {
		return new Promise((resolve, reject) => {
			const reader = new FileReader();
			reader.onload = () => resolve(reader.result);
			reader.onerror = reject;
			reader.readAsDataURL(file);
		});
	}

	// Pancard preview
	const pancardInput = document.getElementById("pancardInput");
	const pancardLabel = document.getElementById("pancardLabel");
	const pancardPreview = document.getElementById("pancardPreview");
	const pancardPreviewImg = document.getElementById("pancardPreviewImg");
	const pancardPreviewText = document.getElementById("pancardPreviewText");

	pancardInput.addEventListener("change", async function (e) {
		const file = this.files && this.files[0];
		if (!file) {
			pancardPreview.style.display = "none";
			pancardLabel.textContent = "Upload PAN Card (PDF/Image)";
			return;
		}

		// Update label and preview
		pancardLabel.textContent = file.name;
		pancardPreview.style.display = "block";

		// Only preview images (PDFs can't be previewed via DataURL reliably)
		if (file.type.startsWith("image/")) {
			try {
				const dataUrl = await readFileAsDataURL(file);
				pancardPreviewImg.src = dataUrl;
				pancardPreviewImg.style.display = "block";
				pancardPreviewText.textContent = "Image preview";
			} catch (err) {
				pancardPreviewImg.style.display = "none";
				pancardPreviewText.textContent = "Preview not available";
			}
		} else {
			pancardPreviewImg.style.display = "none";
			pancardPreviewText.textContent =
				"File selected (preview not available for this file type)";
		}
	});

	// Qualification PDF preview
	const qualificationPdfInput = document.getElementById(
		"qualificationPdfInput"
	);
	const qualificationPdfLabel = document.getElementById(
		"qualificationPdfLabel"
	);
	const qualificationPdfPreview = document.getElementById(
		"qualificationPdfPreview"
	);
	const qualificationPdfPreviewText = document.getElementById(
		"qualificationPdfPreviewText"
	);

	qualificationPdfInput.addEventListener("change", function (e) {
		const file = this.files && this.files[0];
		if (!file) {
			qualificationPdfPreview.style.display = "none";
			qualificationPdfLabel.textContent = "Upload Qualification PDF";
			return;
		}

		qualificationPdfLabel.textContent = file.name;
		qualificationPdfPreview.style.display = "block";
		qualificationPdfPreviewText.textContent = "File selected (PDF)";
	});

	// Google OAuth functionality
	let googleUserData = null;

	function closeGoogleModal() {
		document.getElementById("googleRoleModal").style.display = "none";
		googleUserData = null;
	}

	async function completeGoogleSignup(role) {
		if (!googleUserData) {
			alert("Error: No Google user data available");
			return;
		}

		const btn = event.target;
		btn.disabled = true;
		btn.innerHTML = "Creating account...";

		try {
			const response = await fetch("/auth/google/signup", {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
				},
				body: JSON.stringify({
					...googleUserData,
					role: role,
				}),
			});

			const data = await response.json();

			if (data.success) {
				if (role === "doctor") {
					// For doctors, redirect to a verification page where they can upload qualifications
					window.location.href = data.redirect + "?google_signup=true";
				} else {
					// For patients, redirect to dashboard
					window.location.href = data.redirect;
				}
			} else {
				alert(data.message || "Signup failed");
			}
		} catch (error) {
			console.error("Error:", error);
			alert("An error occurred during signup");
		} finally {
			btn.disabled = false;
			btn.innerHTML =
				role === "doctor" ? "🩺 Continue as Doctor" : "👤 Continue as Patient";
			closeGoogleModal();
		}
	}

	// Import Firebase modules and setup Google OAuth
	document.addEventListener("DOMContentLoaded", function () {
		// Load Firebase config
		import('{{ url_for("static", filename="js/firebase-config.js") }}')
			.then(({ signInWithGoogle }) => {
				document
					.getElementById("googleSignUpBtn")
					.addEventListener("click", async () => {
						const btn = document.getElementById("googleSignUpBtn");
						btn.disabled = true;
						btn.innerHTML = "Connecting to Google...";

						try {
							const result = await signInWithGoogle();

							if (result.success) {
								// Store Google user data
								googleUserData = {
									uid: result.user.uid,
									email: result.user.email,
									displayName: result.user.displayName,
									photoURL: result.user.photoURL,
									emailVerified: result.user.emailVerified,
								};

								// Show role selection modal
								document.getElementById("googleRoleModal").style.display =
									"flex";
							} else {
								alert("Google sign-in failed: " + result.error);
							}
						} catch (error) {
							console.error("Error:", error);
							alert("An error occurred during sign-in");
						} finally {
							btn.disabled = false;
							btn.innerHTML = `
						<svg width="20" height="20" viewBox="0 0 24 24">
							<path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
							<path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
							<path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
							<path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
						</svg>
						Continue with Google
					`;
						}
					});
			})
			.catch((error) => {
				console.error("Error loading Firebase config:", error);
			});
	});
</script>
{% endblock %}
