{% extends "layouts/base.html" %} {% block title %}Secure Messaging{% endblock
%} {% block content %}
<h1
	style="
		font-size: 2.5rem;
		font-weight: bold;
		color: #f8f8f2;
		margin-bottom: 20px;
	">
	ðŸ’¬ Secure Messaging
</h1>

<div
	class="message-grid"
	style="
		display: grid;
		grid-template-columns: 1fr 3fr;
		gap: 20px;
		min-height: 70vh;
	">
	<!-- Contacts -->
	<div class="data-card contact-list-card" style="padding: 0; overflow: hidden">
		<h2 style="padding: 20px 20px 0 20px">Contacts</h2>
		<ul id="contacts" style="list-style: none; padding: 0; margin: 0">
			{% for c in contacts %}
			<li
				class="contact-item"
				data-id="{{ c.id }}"
				style="
					display: flex;
					align-items: center;
					padding: 15px 20px;
					border-bottom: 1px solid var(--drac-card-alt);
					cursor: pointer;
					transition: background-color 0.15s;
				">
				<div
					class="contact-avatar-small"
					style="
						width: 40px;
						height: 40px;
						border-radius: 50%;
						margin-right: 10px;
						background-color: var(--drac-purple);
						color: var(--drac-bg);
						display: flex;
						align-items: center;
						justify-content: center;
						font-weight: 700;
					">
					{{ c.fullname[0] }}
				</div>
				<div style="flex: 1; min-width: 0">
					<div
						class="contact-name"
						style="
							font-weight: 700;
							white-space: nowrap;
							overflow: hidden;
							text-overflow: ellipsis;
						">
						{{ c.fullname }}
					</div>
					<div
						style="
							font-size: 0.8rem;
							color: var(--drac-comment);
							white-space: nowrap;
							overflow: hidden;
							text-overflow: ellipsis;
						">
						{{ c.email or c.phone }}
					</div>
				</div>
			</li>
			{% else %}
			<li style="padding: 20px; color: var(--drac-comment)">
				No contacts found.
			</li>
			{% endfor %}
		</ul>
	</div>

	<!-- Chat window -->
	<div
		class="data-card chat-window"
		style="display: flex; flex-direction: column; padding: 0">
		<div
			class="chat-header"
			style="
				display: flex;
				align-items: center;
				padding: 15px;
				border-bottom: 1px solid var(--drac-card-alt);
			">
			<strong
				id="convTitle"
				style="font-size: 1rem; color: var(--drac-foreground)"
				>Select a contact to begin messaging</strong
			>
		</div>

		<!-- Message list area -->
		<div
			id="messageWrap"
			style="position: relative; flex-grow: 1; overflow: hidden">
			<div
				id="messageList"
				style="
					height: 100%;
					overflow-y: auto;
					padding: 15px;
					background: linear-gradient(180deg, rgba(0, 0, 0, 0.02), transparent);
				">
				<!-- messages injected here -->
			</div>

			<!-- loading overlay -->
			<div
				id="msgLoading"
				style="
					display: none;
					position: absolute;
					inset: 0;
					background: rgba(0, 0, 0, 0.35);
					display: flex;
					align-items: center;
					justify-content: center;
					z-index: 5;
				">
				<div
					style="
						padding: 12px 18px;
						border-radius: 10px;
						background: rgba(40, 42, 54, 0.95);
						color: var(--drac-foreground);
						display: flex;
						gap: 10px;
						align-items: center;
					">
					<div
						class="spinner"
						style="
							width: 18px;
							height: 18px;
							border-radius: 50%;
							border: 3px solid rgba(255, 255, 255, 0.12);
							border-top-color: var(--drac-pink);
							animation: spin 1s linear infinite;
						"></div>
					<div>Loading messagesâ€¦</div>
				</div>
			</div>
		</div>

		<!-- Input area -->
		<div
			class="input-area"
			style="
				display: flex;
				padding: 15px;
				border-top: 1px solid var(--drac-card-alt);
				gap: 10px;
			">
			<input
				type="text"
				id="msgInput"
				class="message-input"
				placeholder="Type a message."
				style="
					flex-grow: 1;
					background-color: var(--drac-card-alt);
					border: none;
					border-radius: 20px;
					padding: 10px 15px;
					color: var(--drac-foreground);
					outline: none;
				" />
			<button
				id="sendBtn"
				class="send-btn"
				style="
					background: linear-gradient(
						135deg,
						var(--drac-green),
						var(--drac-cyan)
					);
					color: var(--drac-bg);
					border: none;
					border-radius: 50%;
					width: 44px;
					height: 44px;
					display: flex;
					align-items: center;
					justify-content: center;
					font-size: 1.1rem;
					cursor: pointer;
				">
				â†’
			</button>
		</div>
	</div>
</div>

<style>
	@keyframes spin {
		to {
			transform: rotate(360deg);
		}
	}
	/* simple message bubble classes */
	.msg-bubble {
		padding: 10px 14px;
		border-radius: 14px;
		margin-bottom: 10px;
		display: inline-block;
		line-height: 1.25;
		max-width: 75%;
		word-wrap: break-word;
		font-size: 0.95rem;
	}
	.msg-me {
		background: var(--drac-purple);
		color: var(--drac-bg);
		margin-left: auto;
		border-bottom-right-radius: 4px;
	}
	.msg-other {
		background: var(--drac-card-alt);
		color: var(--drac-foreground);
		margin-right: auto;
		border-bottom-left-radius: 4px;
	}
	.msg-ts {
		display: block;
		font-size: 0.72rem;
		color: var(--drac-comment);
		margin-top: 6px;
	}
</style>

<script>
	// Safely serialize server-provided other_id (null or number)
	const currentOtherIdInit = "{{ other_id|tojson|safe }}";
	let currentOtherId = currentOtherIdInit;
	let convPoll = null;
	let isLoading = false;

	function setLoading(val) {
		isLoading = !!val;
		document.getElementById("msgLoading").style.display = isLoading
			? "flex"
			: "none";
	}

	function bindContacts() {
		document.querySelectorAll(".contact-item").forEach((el) => {
			el.addEventListener("click", () => {
				document
					.querySelectorAll(".contact-item")
					.forEach((i) => (i.style.backgroundColor = "transparent"));
				el.style.backgroundColor = "var(--drac-bg-header)";
				const id = el.dataset.id;
				const name = el.querySelector(".contact-name")
					? el.querySelector(".contact-name").textContent.trim()
					: "Conversation";
				openConversation(id, name);
			});
		});
	}

	async function openConversation(otherId, name) {
		if (!otherId) return;
		currentOtherId = otherId;
		document.getElementById("convTitle").textContent = `Chat with ${name}`;
		// initial load + start poll
		await loadConversation(true);
		if (convPoll) clearInterval(convPoll);
		convPoll = setInterval(
			() => loadConversation().catch((e) => console.error("convPoll error", e)),
			5000
		);
	}

	async function loadConversation(initial = false) {
		if (!currentOtherId) return;
		// avoid concurrent loads
		if (isLoading) return;
		setLoading(true);
		try {
			const res = await fetch(
				`/api/conversation/${encodeURIComponent(currentOtherId)}`,
				{ credentials: "same-origin" }
			);
			// if server redirects to login it may return HTML; guard against non-json
			const ctype = res.headers.get("content-type") || "";
			if (!res.ok) {
				console.warn("Failed to load conversation", res.status);
				setLoading(false);
				return;
			}
			if (!ctype.includes("application/json")) {
				console.error(
					"Unexpected response content-type while loading conversation:",
					ctype
				);
				setLoading(false);
				return;
			}

			const msgs = await res.json();
			const list = document.getElementById("messageList");
			list.innerHTML = "";
			for (const m of msgs) {
				const wrapper = document.createElement("div");
				wrapper.style.display = "flex";
				wrapper.style.flexDirection = "column";
				wrapper.style.alignItems = m.is_me ? "flex-end" : "flex-start";

				const bubble = document.createElement("div");
				bubble.className = "msg-bubble " + (m.is_me ? "msg-me" : "msg-other");
				bubble.textContent = m.content;

				const ts = document.createElement("span");
				ts.className = "msg-ts";
				ts.textContent = new Date(m.timestamp + "Z").toLocaleString(); // show local time

				wrapper.appendChild(bubble);
				wrapper.appendChild(ts);
				list.appendChild(wrapper);
			}
			// scroll newest into view
			list.scrollTop = list.scrollHeight;
		} catch (err) {
			console.error("Error loading conversation:", err);
		} finally {
			setLoading(false);
		}
	}

	async function sendMessage() {
		const contentEl = document.getElementById("msgInput");
		const btn = document.getElementById("sendBtn");
		const content = contentEl.value.trim();
		if (!content || !currentOtherId) return;
		try {
			btn.disabled = true;
			btn.style.opacity = "0.7";
			// optimistic UI add
			const list = document.getElementById("messageList");
			const wrapper = document.createElement("div");
			wrapper.style.display = "flex";
			wrapper.style.flexDirection = "column";
			wrapper.style.alignItems = "flex-end";
			const bubble = document.createElement("div");
			bubble.className = "msg-bubble msg-me";
			bubble.textContent = content;
			const ts = document.createElement("span");
			ts.className = "msg-ts";
			ts.textContent = "Sendingâ€¦";
			wrapper.appendChild(bubble);
			wrapper.appendChild(ts);
			list.appendChild(wrapper);
			list.scrollTop = list.scrollHeight;

			const res = await fetch("/api/send_message", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				credentials: "same-origin",
				body: JSON.stringify({
					receiver_id: parseInt(currentOtherId, 10),
					content,
				}),
			});

			if (!res.ok) {
				// remove optimistic message and show error
				wrapper.remove();
				notifications.error("Failed to send message (server error).");
				return;
			}
			// success -> clear input and reload conversation to get server timestamps/ids
			contentEl.value = "";
			await loadConversation();
		} catch (err) {
			console.error("sendMessage error", err);
			notifications.error("Failed to send message.");
		} finally {
			document.getElementById("sendBtn").disabled = false;
			document.getElementById("sendBtn").style.opacity = "1";
		}
	}

	document.getElementById("sendBtn").addEventListener("click", sendMessage);
	document.getElementById("msgInput").addEventListener("keydown", (e) => {
		if (e.key === "Enter" && !e.shiftKey) {
			e.preventDefault();
			sendMessage();
		}
	});

	// init
	bindContacts();

	// if server provided other_id select it; otherwise pick first contact automatically
	(function initAutoSelect() {
		if (currentOtherId) {
			const el = document.querySelector(
				`.contact-item[data-id='${currentOtherId}']`
			);
			const name = el
				? el.querySelector(".contact-name").textContent.trim()
				: "Conversation";
			if (el) el.style.backgroundColor = "var(--drac-bg-header)";
			openConversation(currentOtherId, name).catch((e) => console.error(e));
			return;
		}
		const first = document.querySelector(".contact-item");
		if (first) {
			first.style.backgroundColor = "var(--drac-bg-header)";
			const id = first.dataset.id;
			const name = first.querySelector(".contact-name")
				? first.querySelector(".contact-name").textContent.trim()
				: "Conversation";
			openConversation(id, name).catch((e) => console.error(e));
		}
	})();

	// cleanup on unload
	window.addEventListener("beforeunload", () => {
		if (convPoll) clearInterval(convPoll);
	});
</script>

{% endblock %}
