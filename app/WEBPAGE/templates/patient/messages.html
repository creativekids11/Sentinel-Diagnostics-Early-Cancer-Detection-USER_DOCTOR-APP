{% extends "layouts/patient.html" %} {% block title %}Messages{% endblock %} {%
block head %}
<style>
	.msg-bubble {
		padding: 10px 14px;
		border-radius: 14px;
		margin-bottom: 10px;
		display: inline-block;
		line-height: 1.25;
		max-width: 78%;
		word-wrap: break-word;
		font-size: 0.95rem;
	}
	.msg-me {
		background: var(--drac-purple);
		color: var(--drac-bg);
		margin-left: auto;
		border-bottom-right-radius: 14px;
	}
	.msg-other {
		background: var(--drac-card-alt);
		color: var(--drac-foreground);
		margin-right: auto;
		border-bottom-left-radius: 14px;
	}
	.msg-ts {
		display: block;
		font-size: 0.72rem;
		color: var(--drac-comment);
		margin-top: 6px;
	}
	#messageWrap {
		display: flex;
		flex-direction: column;
		flex: 1 1 auto;
		min-height: 0;
		position: relative;
	}
	#messageList {
		flex: 1 1 auto;
		min-height: 0;
		overflow-y: auto;
		padding: 12px;
		background: linear-gradient(180deg, rgba(0, 0, 0, 0.03), transparent);
	}
	#messageList::-webkit-scrollbar {
		width: 10px;
	}
	#messageList::-webkit-scrollbar-thumb {
		background: rgba(0, 0, 0, 0.12);
		border-radius: 8px;
	}
	#messageList::-webkit-scrollbar-track {
		background: transparent;
	}
	
	.filter-btn {
		padding: 4px 8px;
		border: none;
		border-radius: 4px;
		background: var(--drac-card-alt);
		color: var(--drac-comment);
		font-size: 0.8rem;
		cursor: pointer;
		transition: all 0.2s;
	}
	
	.filter-btn.active,
	.filter-btn:hover {
		background: var(--drac-purple);
		color: var(--drac-bg);
	}
	
	.specialization-tag {
		display: inline-block;
		padding: 2px 6px;
		border-radius: 10px;
		font-size: 0.7rem;
		font-weight: bold;
		margin-right: 6px;
		background: var(--drac-green);
		color: var(--drac-bg);
	}
	
	.contact-item.hidden {
		display: none;
	}
</style>
{% endblock %} {% block content %}
<h1 style="font-size: 2rem; margin-bottom: 16px">Messages</h1>

<div
	class="message-grid"
	style="
		display: grid;
		grid-template-columns: 1fr 3fr;
		gap: 20px;
		min-height: 60vh;
	">
	<div class="data-card contact-list-card" style="height: 70vh">
		<h3 style="padding: 12px 16px 8px 16px">Doctors</h3>
		
		<!-- Search input for finding doctors -->
		<div style="padding: 0 16px 8px 16px;">
			<input 
				id="doctorSearch" 
				type="text" 
				placeholder="Search for doctors by name or specialization..."
				style="
					width: 100%;
					padding: 8px 12px;
					border-radius: 8px;
					border: none;
					background: var(--drac-card-alt);
					color: var(--drac-foreground);
					font-size: 0.9rem;
				"
			/>
		</div>
		
		<!-- Filter buttons for specialization -->
		<div style="padding: 0 16px 8px 16px; display: flex; gap: 8px; flex-wrap: wrap;">
			<button id="filterAll" class="filter-btn active" data-filter="all">All</button>
			<button id="filterGeneral" class="filter-btn" data-filter="general">General</button>
			<button id="filterSpecialist" class="filter-btn" data-filter="specialist">Specialist</button>
		</div>
		
		<ul id="contacts" style="list-style: none; padding: 0; margin: 0; max-height: calc(100% - 140px); overflow-y: auto;">
			{% for c in contacts %}
			<li
				class="contact-item"
				data-id="{{ c.id }}"
				data-name="{{ c.fullname|lower }}"
				data-email="{{ c.email|lower if c.email else '' }}"
				data-specialization="{{ c.qualifications|lower if c.qualifications else 'general' }}"
				style="
					padding: 12px 16px;
					border-bottom: 1px solid rgba(255, 255, 255, 0.03);
					cursor: pointer;
				">
				<div style="font-weight: 700">{{ c.fullname or 'Unknown Doctor' }}</div>
				<div style="font-size: 0.85rem; color: var(--drac-comment)">
					{% if c.qualifications %}
						<span class="specialization-tag">{{ c.qualifications }}</span>
					{% endif %}
					{{ c.email or c.phone or '' }}
				</div>
			</li>
			{% else %}
			<li id="noDoctorsMsg" style="padding: 12px; color: var(--drac-comment)">
				No doctors found.
			</li>
			{% endfor %}
		</ul>
	</div>

	<div
		class="data-card chat-window"
		style="display: flex; flex-direction: column; padding: 0; height: 70vh">
		<div
			style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.03)">
			<strong id="convTitle">Select a doctor to start a conversation</strong>
		</div>
		<div
			id="messageWrap"
			style="position: relative; flex-grow: 1; overflow: hidden">
			<div
				id="messageList"
				style="
					flex: 1;
					min-height: 0;
					overflow-y: auto;
					padding: 12px;
					background: linear-gradient(180deg, rgba(0, 0, 0, 0.03), transparent);
				"></div>
			<div
				id="msgLoading"
				style="
					display: none;
					position: absolute;
					inset: 0;
					align-items: center;
					justify-content: center;
					z-index: 5;
				">
				<div
					style="
						padding: 10px 14px;
						border-radius: 8px;
						background: rgba(40, 42, 54, 0.95);
						color: var(--drac-foreground);
					">
					Loading...
				</div>
			</div>
		</div>
		<div
			style="
				display: flex;
				padding: 12px;
				border-top: 1px solid rgba(255, 255, 255, 0.03);
				gap: 8px;
			">
			<input
				id="msgInput"
				placeholder="Type a message"
				style="
					flex: 1;
					padding: 10px;
					border-radius: 20px;
					border: none;
					background: var(--drac-card-alt);
					color: var(--drac-foreground);
				" />
			<button id="sendBtn" class="action-btn">Send</button>
		</div>
	</div>
</div>

<script>
	let currentOtherId = {{ other_id|tojson if other_id else 'null' }};

	// Search and filter functionality for doctors
	function initializeFilters() {
		const searchInput = document.getElementById('doctorSearch');
		const filterButtons = document.querySelectorAll('.filter-btn');
		let currentFilter = 'all';
		
		// Search functionality
		searchInput.addEventListener('input', (e) => {
			const searchTerm = e.target.value.toLowerCase().trim();
			filterDoctors(currentFilter, searchTerm);
		});
		
		// Filter buttons
		filterButtons.forEach(btn => {
			btn.addEventListener('click', () => {
				// Update active button
				filterButtons.forEach(b => b.classList.remove('active'));
				btn.classList.add('active');
				
				currentFilter = btn.dataset.filter;
				const searchTerm = searchInput.value.toLowerCase().trim();
				filterDoctors(currentFilter, searchTerm);
			});
		});
	}
	
	function filterDoctors(filter, searchTerm) {
		const contactItems = document.querySelectorAll('.contact-item');
		let visibleCount = 0;
		
		contactItems.forEach(item => {
			const name = item.dataset.name || '';
			const email = item.dataset.email || '';
			const specialization = item.dataset.specialization || 'general';
			
			// Apply specialization filter
			let filterMatch = (filter === 'all') || 
				(filter === 'general' && specialization === 'general') ||
				(filter === 'specialist' && specialization !== 'general');
			
			// Apply search filter
			let searchMatch = !searchTerm || 
				name.includes(searchTerm) || 
				email.includes(searchTerm) ||
				specialization.includes(searchTerm);
			
			if (filterMatch && searchMatch) {
				item.classList.remove('hidden');
				visibleCount++;
			} else {
				item.classList.add('hidden');
			}
		});
		
		// Show/hide "no doctors" message
		const noDoctorsMsg = document.getElementById('noDoctorsMsg');
		if (noDoctorsMsg) {
			noDoctorsMsg.style.display = visibleCount === 0 ? 'block' : 'none';
		}
	}

	function bindContacts() {
		document.querySelectorAll(".contact-item").forEach((el) =>
			el.addEventListener("click", async () => {
				if (el.classList.contains('hidden')) return; // Don't allow clicking hidden items
				
				document
					.querySelectorAll(".contact-item")
					.forEach((i) => (i.style.background = "transparent"));
				el.style.background = "var(--drac-bg-header)";
				const id = el.dataset.id;
				const name = el.querySelector("div").textContent.trim();
				currentOtherId = id;
				document.getElementById("convTitle").textContent = `Chat with ${name}`;
				await loadConversation();
			})
		);
	}
	
	async function loadConversation() {
		if (!currentOtherId) return;
		document.getElementById("msgLoading").style.display = "flex";
		try {
			const res = await fetch(
				`/api/conversation/${encodeURIComponent(currentOtherId)}`
			);
			if (!res.ok) return;
			const msgs = await res.json();
			const list = document.getElementById("messageList");
			list.innerHTML = "";
			for (const m of msgs) {
				const wrap = document.createElement("div");
				wrap.style.display = "flex";
				wrap.style.flexDirection = "column";
				wrap.style.alignItems = m.is_me ? "flex-end" : "flex-start";
				const bubble = document.createElement("div");
				bubble.className = "msg-bubble " + (m.is_me ? "msg-me" : "msg-other");
				bubble.textContent = m.content;
				const ts = document.createElement("span");
				ts.className = "msg-ts";
				// use ISO timestamp if present and format via browser locale/timezone
				const iso = m.timestamp_iso || m.timestamp;
				try {
					const d = new Date(iso);
					ts.textContent = new Intl.DateTimeFormat(undefined, {
						dateStyle: "medium",
						timeStyle: "short",
					}).format(d);
				} catch (e) {
					ts.textContent = m.timestamp;
				}
				wrap.appendChild(bubble);
				wrap.appendChild(ts);
				list.appendChild(wrap);
			}
			// smooth scroll to bottom
			list.scrollTo({ top: list.scrollHeight, behavior: "smooth" });
		} catch (e) {
			console.error(e);
		} finally {
			document.getElementById("msgLoading").style.display = "none";
		}
	}
	
	async function sendMessage() {
		const input = document.getElementById("msgInput");
		const content = input.value.trim();
		if (!content || !currentOtherId) return;
		try {
			const res = await fetch("/api/send_message", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({
					receiver_id: parseInt(currentOtherId, 10),
					content,
				}),
			});
			if (!res.ok) {
				notifications.error("Failed to send");
				return;
			}
			input.value = "";
			await loadConversation();
		} catch (e) {
			console.error(e);
		}
	}
	
	document.getElementById("sendBtn").addEventListener("click", sendMessage);
	document.getElementById("msgInput").addEventListener("keydown", (e) => {
		if (e.key === "Enter" && !e.shiftKey) {
			e.preventDefault();
			sendMessage();
		}
	});
	
	// Initialize everything
	initializeFilters();
	bindContacts();
	
	if (currentOtherId) {
		const el = document.querySelector(
			`.contact-item[data-id='${currentOtherId}']`
		);
		if (el) {
			el.style.background = "var(--drac-bg-header)";
			loadConversation();
		}
	} else {
		const first = document.querySelector(".contact-item:not(.hidden)");
		if (first) {
			first.style.background = "var(--drac-bg-header)";
			first.click();
		}
	}
</script>

{% endblock %}
