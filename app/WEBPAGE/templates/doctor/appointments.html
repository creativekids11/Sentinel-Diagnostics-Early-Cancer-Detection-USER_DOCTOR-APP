{% extends "layouts/doctor.html" %}
{% block title %}Manage Appointments{% endblock %}
{% block content %}
<div class="data-card">
    <h2>Manage Appointments</h2>
    <p style="color: var(--drac-comment); margin-top: -15px; margin-bottom: 20px;">Confirm, reject, or start meetings for patient consultations.</p>
    <table class="patient-table">
        <thead>
            <tr>
                <th>Scheduled Time</th>
                <th>Patient</th>
                <th>Contact</th>
                <th>Reason</th>
                <th>Status</th>
                <th style="width:320px">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for appt in appointments %}
            <tr data-appointment-id="{{ appt.id }}">
                    <td>
                        {% if appt.scheduled_at.__class__.__name__ == 'str' %}
                            {{ appt.scheduled_at }}
                        {% else %}
                            {{ appt.scheduled_at.strftime('%Y-%m-%d %I:%M %p') }}
                        {% endif %}
                    </td>
                <td>{{ appt.patient_name }}</td>
                <td>{{ appt.patient_email or appt.patient_phone }}</td>
                <td>{{ appt.reason or 'â€”' }}</td>
                <td>
                    {% if appt.status == 'confirmed' %}<span class="status-low">{{ appt.status|capitalize }}</span>
                    {% elif appt.status in ['rejected', 'cancelled'] %}<span class="status-high">{{ appt.status|capitalize }}</span>
                    {% else %}<span class="status-medium">{{ appt.status|capitalize }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if appt.status == 'pending' %}
                    <form method="POST" action="{{ url_for('doctor_appt_action', appt_id=appt.id) }}" style="display:inline-block;">
                        <input type="hidden" name="action" value="confirmed" />
                        <button class="action-btn" style="background-color: var(--drac-green); color: var(--drac-bg-darker);" type="submit">Confirm</button>
                    </form>
                    <form method="POST" action="{{ url_for('doctor_appt_action', appt_id=appt.id) }}" style="display:inline-block; margin-left:6px;">
                        <input type="hidden" name="action" value="rejected" />
                        <button class="action-btn" style="background-color: var(--drac-red);" type="submit">Reject</button>
                    </form>
                    {% elif appt.status == 'confirmed' %}
                        {% if appt.meeting_url %}
                            <a href="#" onclick="checkPatientPlanAndJoin('{{ appt.user_id }}', '{{ appt.meeting_url }}', '{{ appt.patient_name }}', '{{ appt.id }}')" class="action-btn" style="background: linear-gradient(135deg, var(--drac-pink), var(--drac-purple));">Join Meeting</a>
                            <a href="{{ url_for('open_meeting', appt_id=appt.id) }}" style="margin-left:10px; color:var(--drac-cyan);">Open In-App</a>
                        {% else %}
                            <form method="POST" action="{{ url_for('doctor_appt_action', appt_id=appt.id) }}" style="display:inline-block;">
                                <input type="hidden" name="action" value="meet" />
                                <button class="action-btn" style="background: linear-gradient(135deg, var(--drac-pink), var(--drac-purple));" type="submit">Start Meeting</button>
                            </form>
                        {% endif %}
                        <form method="POST" action="{{ url_for('doctor_appt_action', appt_id=appt.id) }}" style="display:inline-block; margin-left:6px;" onsubmit="return handleResolve(event, {{ appt.id }})">
                            <input type="hidden" name="action" value="resolved" />
                            <button class="action-btn" style="background-color: var(--drac-purple);" type="submit">Resolve</button>
                        </form>
                    {% elif appt.status == 'resolved' %}
                        <button class="action-btn delete-btn" style="background-color: var(--drac-red);" 
                                onclick="deleteDoctorAppointment({{ appt.id }}, 'resolved')">Delete</button>
                    {% elif appt.status in ['rejected', 'cancelled'] %}
                        <button class="action-btn delete-btn" style="background-color: var(--drac-red);" 
                                onclick="deleteDoctorAppointment({{ appt.id }}, '{{ appt.status }}')">Delete</button>
                    {% else %}
                    -
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr><td colspan="6" style="text-align:center;">No appointments found.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
// Notification system
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
        background-color: ${type === 'success' ? '#50fa7b' : type === 'error' ? '#ff5555' : '#ffb86c'};
    `;
    notification.textContent = message;
    
    // Add animation CSS
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.remove();
        style.remove();
    }, 3000);
}

function showResolvedNotification(appointmentId) {
    showNotification('Problem resolved successfully! Appointment will be deleted in 10 seconds.', 'success');
    
    // Auto-delete after 10 seconds
    setTimeout(() => {
        deleteResolvedAppointment(appointmentId, true); // true flag for auto-delete
    }, 10000);
}

function handleResolve(event, appointmentId) {
    // Show notification immediately
    showNotification('Problem resolved successfully! Appointment will be automatically deleted in 10 seconds.', 'success');
    
    // Allow form submission to proceed
    return true;
}

async function deleteDoctorAppointment(appointmentId, status) {
    const statusText = status === 'resolved' ? 'resolved' : status === 'rejected' ? 'rejected' : 'cancelled';
    
    if (!confirm(`Are you sure you want to permanently delete this ${statusText} appointment?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/doctor/appointments/${appointmentId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        
        if (response.ok) {
            const result = await response.json();
            // Remove the row from the table
            const row = document.querySelector(`tr[data-appointment-id="${appointmentId}"]`);
            if (row) {
                row.remove();
            }
            showNotification(result.message || `${statusText.charAt(0).toUpperCase() + statusText.slice(1)} appointment deleted successfully!`, 'success');
            // Small delay before reload to show notification
            setTimeout(() => window.location.reload(), 1000);
        } else {
            const result = await response.json();
            showNotification(result.message || 'Failed to delete appointment. Please try again.', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('An error occurred while deleting the appointment.', 'error');
    }
}

async function deleteResolvedAppointment(appointmentId, autoDelete = false) {
    if (!autoDelete && !confirm('Are you sure you want to permanently delete this resolved appointment?')) {
        return;
    }
    
    try {
        const response = await fetch(`/doctor/appointments/${appointmentId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        
        if (response.ok) {
            const result = await response.json();
            // Remove the row from the table
            const row = document.querySelector(`tr[data-appointment-id="${appointmentId}"]`);
            if (row) {
                row.remove();
            }
            showNotification(result.message || 'Resolved appointment deleted successfully!', 'success');
            // Small delay before reload to show notification
            setTimeout(() => window.location.reload(), 1000);
        } else {
            const result = await response.json();
            showNotification(result.message || 'Failed to delete appointment. Please try again.', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('An error occurred while deleting the appointment.', 'error');
    }
}

// Function to check patient's plan before joining meeting
async function checkPatientPlanAndJoin(userId, meetingUrl, patientName, appointmentId) {
    // Since the meeting URL exists, the meeting was already started
    // Doctors can join existing meetings regardless of patient subscription
    window.open(meetingUrl, '_blank');
}
</script>
{% endblock %}