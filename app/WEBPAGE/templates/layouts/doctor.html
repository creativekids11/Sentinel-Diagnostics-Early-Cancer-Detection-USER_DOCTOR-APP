{% extends "layouts/base.html" %} {% block body %}
<div class="sidebar">
	<div class="logo">
		<img src="{{ url_for('static', filename='assets/logo.png') }}" alt="Logo" style="height: 60px; width: auto;">
	</div>
	<div class="nav-link-group">
		<a
			href="{% if user_subscription and user_subscription.plan == 'premium' %}{{ url_for('doctor_dashboard') }}{% else %}{{ url_for('doctor_manage_plans') }}{% endif %}"
			class="nav-link {% if request.endpoint == 'doctor_dashboard' %}nav-link-active{% endif %} {% if not user_subscription or user_subscription.plan != 'premium' %}nav-link-disabled{% endif %}"
			{% if not user_subscription or user_subscription.plan != 'premium' %}onclick="return confirm('Upgrade to Premium to access this feature. Click OK to go to Manage Plans.');"{% endif %}>
			<img src="/static/icons/Dashboard.png" alt="Dashboard" style="height: 20px; margin-right: 5px;"> Dashboard
		</a>
		<a
			href="{% if user_subscription and user_subscription.plan == 'premium' %}{{ url_for('doctor_risk_assessment') }}{% else %}{{ url_for('doctor_manage_plans') }}{% endif %}"
			class="nav-link {% if request.endpoint == 'doctor_risk_assessment' %}nav-link-active{% endif %} {% if not user_subscription or user_subscription.plan != 'premium' %}nav-link-disabled{% endif %}"
			{% if not user_subscription or user_subscription.plan != 'premium' %}onclick="return confirm('Upgrade to Premium to access this feature. Click OK to go to Manage Plans.');"{% endif %}>
			<img src="/static/icons/Risk_assessments.png" alt="Risk Assessment" style="height: 20px; margin-right: 5px;"> Risk Assessment
		</a>
		<a
			href="{% if user_subscription and user_subscription.plan == 'premium' %}{{ url_for('doctor_patients') }}{% else %}{{ url_for('doctor_manage_plans') }}{% endif %}"
			class="nav-link {% if request.endpoint == 'doctor_patients' %}nav-link-active{% endif %} {% if not user_subscription or user_subscription.plan != 'premium' %}nav-link-disabled{% endif %}"
			{% if not user_subscription or user_subscription.plan != 'premium' %}onclick="return confirm('Upgrade to Premium to access this feature. Click OK to go to Manage Plans.');"{% endif %}>
			<img src="/static/icons/Patients.png" alt="Patients" style="height: 20px; margin-right: 5px;"> Patients
		</a>
		<a
			href="{% if user_subscription and user_subscription.plan == 'premium' %}{{ url_for('doctor_appointments') }}{% else %}{{ url_for('doctor_manage_plans') }}{% endif %}"
			class="nav-link {% if request.endpoint in ['doctor_appointments', 'doctor_appt_action'] %}nav-link-active{% endif %} {% if not user_subscription or user_subscription.plan != 'premium' %}nav-link-disabled{% endif %}"
			{% if not user_subscription or user_subscription.plan != 'premium' %}onclick="return confirm('Upgrade to Premium to access this feature. Click OK to go to Manage Plans.');"{% endif %}>
			<img src="/static/icons/Appointments.png" alt="Appointments" style="height: 20px; margin-right: 5px;"> Appointments
		</a>
		<a
			href="{% if user_subscription and user_subscription.plan == 'premium' %}{{ url_for('doctor_cases') }}{% else %}{{ url_for('doctor_manage_plans') }}{% endif %}"
			class="nav-link {% if request.endpoint in ['doctor_cases', 'update_case'] %}nav-link-active{% endif %} {% if not user_subscription or user_subscription.plan != 'premium' %}nav-link-disabled{% endif %}"
			{% if not user_subscription or user_subscription.plan != 'premium' %}onclick="return confirm('Upgrade to Premium to access this feature. Click OK to go to Manage Plans.');"{% endif %}>
			<img src="/static/icons/Cases.png" alt="Cases" style="height: 20px; margin-right: 5px;"> Cases
		</a>
		<a
			href="{% if user_subscription and user_subscription.plan == 'premium' %}{{ url_for('aiscanner_page') }}{% else %}{{ url_for('doctor_manage_plans') }}{% endif %}"
			class="nav-link {% if request.endpoint == 'aiscanner_page' %}nav-link-active{% endif %} {% if not user_subscription or user_subscription.plan != 'premium' %}nav-link-disabled{% endif %}"
			{% if not user_subscription or user_subscription.plan != 'premium' %}onclick="return confirm('Upgrade to Premium to access this feature. Click OK to go to Manage Plans.');"{% endif %}>
			<img src="/static/icons/AI_Scanner.png" alt="AI Scanner" style="height: 20px; margin-right: 5px;"> AI Scanner
		</a>
		<a
			href="{% if user_subscription and user_subscription.plan == 'premium' %}{{ url_for('messages') }}{% else %}{{ url_for('doctor_manage_plans') }}{% endif %}"
			class="nav-link {% if request.endpoint == 'messages' %}nav-link-active{% endif %} {% if not user_subscription or user_subscription.plan != 'premium' %}nav-link-disabled{% endif %}"
			{% if not user_subscription or user_subscription.plan != 'premium' %}onclick="return confirm('Upgrade to Premium to access this feature. Click OK to go to Manage Plans.');"{% endif %}>
			<img src="/static/icons/Messages.png" alt="Messages" style="height: 20px; margin-right: 5px;"> Messages
		</a>
		<a
			href="{% if user_subscription and user_subscription.plan == 'premium' %}{{ url_for('doctor_reports') }}{% else %}{{ url_for('doctor_manage_plans') }}{% endif %}"
			class="nav-link {% if request.endpoint == 'doctor_reports' %}nav-link-active{% endif %} {% if not user_subscription or user_subscription.plan != 'premium' %}nav-link-disabled{% endif %}"
			{% if not user_subscription or user_subscription.plan != 'premium' %}onclick="return confirm('Upgrade to Premium to access this feature. Click OK to go to Manage Plans.');"{% endif %}>
			<img src="/static/icons/Report.png" alt="Reports" style="height: 20px; margin-right: 5px;"> Reports
		</a>
		<a
			href="{{ url_for('doctor_manage_plans') }}"
			class="nav-link {% if request.endpoint == 'doctor_manage_plans' %}nav-link-active{% endif %}">
			<img src="{{ url_for('static', filename='icons/manage_plans.png') }}" alt="Manage Plans" style="height: 20px; margin-right: 5px;"> Manage Plans
		</a>
	</div>
	</div>
</div>
</div>

<div class="main-content">
	<header class="header">
		<div class="header-right" style="margin-left:auto; display:flex; align-items:center; gap:12px; position: relative;">
			<!-- Notification Bell -->
			<div class="notification-bell" style="position: relative; cursor: pointer;" onclick="toggleNotifications()">
				<div style="position: relative; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; transition: all 0.3s ease;">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: var(--drac-foreground);">
						<path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
					</svg>
					<span id="notificationBadge" class="notification-badge" style="position: absolute; top: -2px; right: -2px; background: #ff4757; color: white; border-radius: 50%; min-width: 18px; height: 18px; display: none; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; border: 2px solid var(--drac-bg);">0</span>
				</div>
			</div>
			
			{% if current_user %}
			<div class="header-profile" style="display:flex; align-items:center; gap:10px; cursor:pointer; position: relative;">
				<div class="profile-avatar" style="background-color: var(--drac-green); width:42px; height:42px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#111; font-weight:700; min-width:42px; min-height:42px;">
				{{ current_user.fullname[0] if current_user and current_user.fullname else 'D' }}
				</div>
				<div style="display:flex; flex-direction:column; align-items:flex-start;">
					<div class="profile-name" style="font-weight:700;">{{ current_user.fullname if current_user and current_user.fullname else 'Doctor' }}</div>
					{% if user_subscription and user_subscription.plan != 'free' %}
					<div class="subscription-badge-header subscription-{{ user_subscription.plan }}">
						{{ user_subscription.plan }}
					</div>
					{% endif %}
				</div>
			</div>
			{% endif %}
			<a
				href="{{ url_for('logout') }}"
				class="action-btn"
				style="background: #e74c3c; text-decoration: none; color: inherit"
				>Logout</a>

			<!-- Header Profile Popup -->
			<div id="statusPopupHeader" class="card" style="max-height: 0; overflow: hidden; position:absolute; top: 56px; right: 0; width: 290px; max-width: 90vw; background:var(--drac-card); border:1px solid var(--drac-comment); border-radius:12px; box-shadow:0 10px 28px rgba(0,0,0,0.45); color:var(--drac-foreground); z-index: 1100; box-sizing: border-box; transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out; opacity: 0;">
				<div class="card-body py-3 px-3 text-center">
					<div class="mx-auto d-flex align-items-center justify-content-center" style="width:68px; height:68px; border-radius:50%; background: var(--drac-green); color: var(--drac-bg); font-weight:700; font-size:28px;">{{ current_user.fullname[0] if current_user and current_user.fullname else 'D' }}</div>
					<div class="mt-2" style="font-size:1.05rem; font-weight: 800; line-height:1.1; word-wrap: break-word;">{{ current_user.fullname if current_user and current_user.fullname else 'Doctor' }}</div>
					
					<!-- Subscription Status -->
					<div class="mt-2 mb-3">
						{% if user_subscription and user_subscription.plan != 'free' %}
						<div class="subscription-badge-popup subscription-{{ user_subscription.plan }}" style="display: inline-block; font-size: 12px; padding: 4px 8px; border-radius: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: white;">
							{{ user_subscription.plan }} Plan
						</div>
						{% if user_subscription.expires_at %}
						<div style="font-size: 11px; color: var(--drac-comment); margin-top: 4px;">
							Valid until {{ user_subscription.expires_at[:10] }}
						</div>
						{% endif %}
						{% else %}
						<div style="font-size: 12px; color: var(--drac-comment); padding: 4px 8px; border: 1px solid var(--drac-comment); border-radius: 10px; display: inline-block;">
							Free Plan
						</div>
						{% endif %}
					</div>
					
					<a href="#" id="editProfileBtn" class="edit-profile-btn mt-2 p-2 d-flex align-items-center justify-content-between" style="border:1px solid var(--drac-comment); border-radius:10px; background: linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02)); text-decoration:none; color:var(--drac-foreground); transition: background-color .15s ease, border-color .15s ease;">
						<div class="d-flex align-items-center gap-2">
							<span style="font-size:16px;">👤</span>
							<span style="font-weight:700;">Edit Profile</span>
						</div>
						<span class="status-arrow">&gt;</span>
					</a>
					<div id="currentStatusRowHeader" class="mt-3 p-2 d-flex align-items-center justify-content-between" style="border:1px solid var(--drac-comment); border-radius:10px; background: linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02)); cursor: pointer; transition: background-color .15s ease, border-color .15s ease;">
						<div class="d-flex align-items-center gap-2" style="min-width: 0; flex-shrink: 1;">
							<span id="currentStatusDotHeader" class="badge rounded-pill" style="width:10px; height:10px; padding:0; background: var(--drac-green); flex-shrink: 0;"></span>
							<span id="currentStatusTextHeader" style="font-weight:700; white-space: nowrap;">Active</span>
						</div>
						<div class="d-flex align-items-center" style="gap:6px; flex-shrink: 0;">
							<span id="currentStatusMetaHeader" style="color: var(--drac-comment); font-size:11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;"></span>
							<span class="status-arrow" style="transform: rotate(90deg); transition: transform 0.2s ease;">&gt;</span>
						</div>
					</div>
					<div style="font-size:12px; color: var(--drac-comment); margin-top:6px;">Click to set status</div>

					<!-- Status Dropdown Menu -->
					<div id="statusDropdownHeader" style="max-height: 0; overflow: hidden; border: 1px solid var(--drac-comment); border-radius: 10px; background: linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02)); transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out; padding: 0; margin-top: 0; z-index: 1102; position: relative;">
						<div class="status-option status-active" data-status="available" style="padding: 12px 16px; border-bottom: 1px solid var(--drac-comment); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all .15s ease; position: relative; pointer-events: auto; z-index: 10;">
							<div class="status-indicator" style="width: 4px; height: 24px; background: var(--drac-green); border-radius: 2px; position: absolute; left: 0;"></div>
							<span class="badge rounded-pill" style="width:10px; height:10px; padding:0; background: var(--drac-green); flex-shrink: 0;"></span>
							<span style="font-weight: 600; color: var(--drac-foreground);">Active</span>
							<div class="status-bg" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(80, 250, 123, 0.08); opacity: 0; transition: opacity 0.15s ease;"></div>
						</div>
						<div class="status-option status-busy" data-status="busy" style="padding: 12px 16px; border-bottom: 1px solid var(--drac-comment); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all .15s ease; position: relative; pointer-events: auto; z-index: 10;">
							<div class="status-indicator" style="width: 4px; height: 24px; background: var(--drac-orange); border-radius: 2px; position: absolute; left: 0;"></div>
							<span class="badge rounded-pill" style="width:10px; height:10px; padding:0; background: var(--drac-orange); flex-shrink: 0;"></span>
							<span style="font-weight: 600; color: var(--drac-foreground);">Busy</span>
							<div class="status-bg" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 184, 108, 0.08); opacity: 0; transition: opacity 0.15s ease;"></div>
						</div>
						<div class="status-option status-emergency" data-status="emergency" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all .15s ease; position: relative; pointer-events: auto; z-index: 10;">
							<div class="status-indicator" style="width: 4px; height: 24px; background: var(--drac-red); border-radius: 2px; position: absolute; left: 0;"></div>
							<span class="badge rounded-pill" style="width:10px; height:10px; padding:0; background: var(--drac-red); flex-shrink: 0;"></span>
							<span style="font-weight: 600; color: var(--drac-foreground);">Emergency</span>
							<div class="status-bg" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 85, 85, 0.08); opacity: 0; transition: opacity 0.15s ease;"></div>
						</div>
					</div>
			</div>
			<!-- Header Submenu -->
			<div id="statusSubmenuHeader" class="card" style="display:none; position:absolute; background:var(--drac-card); border:1px solid var(--drac-comment); border-radius:10px; box-shadow:0 10px 28px rgba(0,0,0,0.45); color:var(--drac-foreground); z-index: 1101; min-width: 240px; max-width: 280px;">
				<div class="list-group list-group-flush" style="background:transparent;">
					<button type="button" class="list-group-item list-group-item-action d-flex align-items-center" data-status="available" style="background:transparent; color:var(--drac-foreground); border-color: var(--drac-card);">
						<span class="badge rounded-pill me-2" style="background: var(--drac-green);">&nbsp;</span>
						Active
					</button>
					<button type="button" class="list-group-item list-group-item-action d-flex align-items-center" data-status="busy" style="background:transparent; color:var(--drac-foreground); border-color: var(--drac-card);">
						<span class="badge rounded-pill me-2" style="background: var(--drac-orange);">&nbsp;</span>
						Busy
					</button>
					<button type="button" class="list-group-item list-group-item-action d-flex align-items-center" data-status="emergency" style="background:transparent; color:var(--drac-foreground); border-color: var(--drac-card);">
						<span class="badge rounded-pill me-2" style="background: var(--drac-red);">&nbsp;</span>
						Emergency
					</button>
				</div>
			</div>

			<!-- Edit Profile Modal -->
			<div id="editProfileModal" class="edit-profile-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1200; align-items: center; justify-content: center;">
				<div class="edit-profile-content" style="background: var(--drac-card); border: 1px solid var(--drac-comment); border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
					<div class="edit-profile-header" style="padding: 20px 24px; border-bottom: 1px solid var(--drac-comment); display: flex; align-items: center; justify-content: space-between;">
						<h3 style="margin: 0; color: var(--drac-foreground); font-weight: 700;">Edit Profile</h3>
						<button id="closeEditProfileModal" class="close-modal-btn" style="background: none; border: none; color: var(--drac-comment); font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s;">×</button>
					</div>
					<form id="editProfileForm" class="edit-profile-form" style="padding: 24px;">
						<div class="form-group" style="margin-bottom: 20px;">
							<label for="editFullName" style="display: block; margin-bottom: 8px; color: var(--drac-foreground); font-weight: 600;">Full Name</label>
							<input type="text" id="editFullName" name="fullname" style="width: 100%; padding: 12px; border: 1px solid var(--drac-comment); border-radius: 8px; background: var(--drac-bg); color: var(--drac-foreground); font-size: 14px;" value="{{ current_user.fullname if current_user and current_user.fullname else '' }}" required>
						</div>
						<div class="form-group" style="margin-bottom: 20px;">
							<label for="editEmail" style="display: block; margin-bottom: 8px; color: var(--drac-foreground); font-weight: 600;">Email</label>
							<input type="email" id="editEmail" name="email" style="width: 100%; padding: 12px; border: 1px solid var(--drac-comment); border-radius: 8px; background: var(--drac-bg); color: var(--drac-foreground); font-size: 14px;" value="{{ current_user.email if current_user and current_user.email else '' }}" required>
						</div>
						<div class="form-group" style="margin-bottom: 20px;">
							<label for="editPhone" style="display: block; margin-bottom: 8px; color: var(--drac-foreground); font-weight: 600;">Phone Number</label>
							<input type="tel" id="editPhone" name="phone" style="width: 100%; padding: 12px; border: 1px solid var(--drac-comment); border-radius: 8px; background: var(--drac-bg); color: var(--drac-foreground); font-size: 14px;" value="{{ current_user.phone if current_user and current_user.phone else '' }}">
						</div>
						<div class="form-group" style="margin-bottom: 20px;">
							<label for="editSpecialization" style="display: block; margin-bottom: 8px; color: var(--drac-foreground); font-weight: 600;">Specialization</label>
							<input type="text" id="editSpecialization" name="specialization" style="width: 100%; padding: 12px; border: 1px solid var(--drac-comment); border-radius: 8px; background: var(--drac-bg); color: var(--drac-foreground); font-size: 14px;" value="{{ current_user.specialization if current_user and current_user.specialization else '' }}">
						</div>
						<div class="form-group" style="margin-bottom: 24px;">
							<label for="editProfilePhoto" style="display: block; margin-bottom: 8px; color: var(--drac-foreground); font-weight: 600;">Profile Photo</label>
							<input type="file" id="editProfilePhoto" name="profile_photo" accept="image/png,image/jpeg,image/jpg,image/gif" style="width: 100%; padding: 12px; border: 1px solid var(--drac-comment); border-radius: 8px; background: var(--drac-bg); color: var(--drac-foreground); font-size: 14px;">
							<small style="color: var(--drac-comment); font-size: 12px; margin-top: 4px; display: block;">Accepted formats: PNG, JPG, JPEG, GIF. Max size: 5MB</small>
						</div>
						<div class="theme" style="margin-bottom: 24px;">
							<label for="theme" style="display: block; margin-bottom: 8px; color: var(--drac-foreground); font-weight: 600;">Theme</label>
							<label class="switch">
  								<input type="checkbox" id="theme-toggle">
  								<span class="slider round"></span>
							</label>
						</div>
						<div class="form-actions" style="display: flex; gap: 12px; justify-content: flex-end;">
							<button type="button" id="cancelEditProfile" class="cancel-btn" style="padding: 10px 20px; border: 1px solid var(--drac-comment); border-radius: 8px; background: transparent; color: var(--drac-foreground); cursor: pointer; transition: background-color 0.2s;">Cancel</button>
							<button type="submit" class="save-btn" style="padding: 10px 20px; border: none; border-radius: 8px; background: var(--drac-green); color: #111; font-weight: 600; cursor: pointer; transition: background-color 0.2s;">Save Changes</button>
						</div>
					</form>
				</div>
			</div>

		<style>
			.switch {
				position: relative;
				display: inline-block;
				width: 60px;
				height: 34px;
			}

			.switch input { 
				opacity: 0;
				width: 0;
				height: 0;
			}

			.slider {
				position: absolute;
				cursor: pointer;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: #ccc;
				-webkit-transition: .4s;
				transition: .4s;
			}

			.slider:before {
				position: absolute;
				content: "";
				height: 26px;
				width: 26px;
				left: 4px;
				bottom: 4px;
				background-color: white;
				-webkit-transition: .4s;
				transition: .4s;
			}

			input:checked + .slider {
				background-color: #1d1d1d;
			}

			input:focus + .slider {
				box-shadow: 0 0 1px #1d1d1d;
			}

			input:checked + .slider:before {
				-webkit-transform: translateX(26px);
				-ms-transform: translateX(26px);
				transform: translateX(26px);
			}

			/* Rounded sliders */
			.slider.round {
				border-radius: 34px;
			}

			.slider.round:before {
				border-radius: 50%;
			}

			/* Sidebar positioning context */
			.sidebar {
				position: relative;
				overflow: visible;
			}
			
			/* Profile section positioning */
			.profile-section {
				position: relative;
			}
			
			/* Status popup constrained to sidebar width */
			#statusPopupSidebar {
				position: absolute;
				max-width: 100% !important;
				width: 100% !important;
				box-sizing: border-box !important;
			}
			
			#statusPopupSidebar .card-body {
				padding: 12px !important;
				overflow: hidden;
			}
			
			/* Status submenu positioning - appears to the right of popup */
			#statusSubmenu {
				position: absolute;
				min-width: 240px;
				max-width: 280px;
			}
			
			/* Edit Profile button hover */
			.edit-profile-btn:hover {
				background: rgba(255,255,255,0.06) !important;
				border-color: var(--drac-foreground) !important;
			}
			
			/* Current Status Row hover */
			#currentStatusRow { 
				transition: background-color .15s ease, border-color .15s ease; 
			}
			#currentStatusRow:hover { 
				background: rgba(255,255,255,0.06) !important; 
				border-color: var(--drac-foreground); 
			}
			
			/* Header status row hover */
			#currentStatusRowHeader {
				transition: background-color .15s ease, border-color .15s ease;
			}
			#currentStatusRowHeader:hover {
				background: rgba(255,255,255,0.06) !important;
				border-color: var(--drac-foreground) !important;
			}
			
			/* Status dropdown options */
			.status-option {
				position: relative;
				padding-left: 20px; /* Make room for the indicator */
			}
			.status-option:hover .status-bg {
				opacity: 1 !important;
			}
			.status-indicator {
				transition: all 0.15s ease;
			}
			.status-option:hover .status-indicator {
				width: 6px !important;
			}
			
			/* Specific status colors */
			.status-active {
				background: var(--drac-green);
				border: 2px solid var(--drac-green);
				border-bottom: 1px solid var(--drac-comment);
				color: var(--drac-foreground);
			}
			.status-active:hover {
				background: transparent;
				border-left: 4px solid var(--drac-green);
				border-top: 2px solid var(--drac-green);
				border-right: 2px solid var(--drac-green);
				border-bottom: 1px solid var(--drac-comment);
				color: var(--drac-green);
			}
			.status-busy {
				border: 2px solid var(--drac-orange);
				border-bottom: 1px solid var(--drac-comment);
				color: var(--drac-orange);
			}
			.status-busy:hover {
				border: 2px solid var(--drac-orange);
				border-bottom: 1px solid var(--drac-comment);
				background: rgba(255, 184, 108, 0.1);
			}
			.status-emergency {
				border: 2px solid var(--drac-red);
				border-bottom: 1px solid var(--drac-comment);
				color: var(--drac-red);
			}
			.status-emergency:hover {
				border: 2px solid var(--drac-red);
				border-bottom: 1px solid var(--drac-comment);
				background: rgba(255, 85, 85, 0.1);
			}
			
			/* Status submenu items hover */
			.list-group-item.list-group-item-action {
				transition: background-color .15s ease, border-color .15s ease, transform .1s ease;
			}
			.list-group-item.list-group-item-action:hover {
				background: rgba(255,255,255,0.08) !important;
				border-color: var(--drac-foreground) !important;
				transform: translateX(3px);
			}
			
			/* Status legend and arrow */
			.status-legend { 
				display: inline-flex; 
				align-items: center; 
				gap: 4px; 
			}
			.status-legend .dot { 
				width: 7px; 
				height: 7px; 
				border-radius: 50%; 
				display: inline-block; 
				opacity: 0.85; 
			}
			.status-arrow { 
				color: var(--drac-comment); 
				font-weight: 900; 
			}
			
			/* Edit Profile Modal Styles */
			.edit-profile-modal {
				display: flex;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.7);
				z-index: 1200;
				align-items: center;
				justify-content: center;
				opacity: 0;
				transition: opacity 0.3s ease;
			}
			.edit-profile-modal.show {
				opacity: 1;
			}
			.edit-profile-content {
				background: var(--drac-card);
				border: 1px solid var(--drac-comment);
				border-radius: 12px;
				box-shadow: 0 20px 40px rgba(0,0,0,0.5);
				max-width: 500px;
				width: 90%;
				max-height: 90vh;
				overflow-y: auto;
				transform: scale(0.9);
				transition: transform 0.3s ease;
			}
			.edit-profile-modal.show .edit-profile-content {
				transform: scale(1);
			}
			.edit-profile-header {
				padding: 20px 24px;
				border-bottom: 1px solid var(--drac-comment);
				display: flex;
				align-items: center;
				justify-content: space-between;
			}
			.edit-profile-header h3 {
				margin: 0;
				color: var(--drac-foreground);
				font-weight: 700;
			}
			.close-modal-btn {
				background: none;
				border: none;
				color: var(--drac-comment);
				font-size: 24px;
				cursor: pointer;
				padding: 0;
				width: 32px;
				height: 32px;
				display: flex;
				align-items: center;
				justify-content: center;
				border-radius: 50%;
				transition: background-color 0.2s, color 0.2s;
			}
			.close-modal-btn:hover {
				background: rgba(255,255,255,0.1);
				color: var(--drac-foreground);
			}
			.edit-profile-form {
				padding: 24px;
			}
			.form-group {
				margin-bottom: 20px;
			}
			.form-group label {
				display: block;
				margin-bottom: 8px;
				color: var(--drac-foreground);
				font-weight: 600;
			}
			.form-group input {
				width: 100%;
				padding: 12px;
				border: 1px solid var(--drac-comment);
				border-radius: 8px;
				background: var(--drac-bg);
				color: var(--drac-foreground);
				font-size: 14px;
				transition: border-color 0.2s, box-shadow 0.2s;
			}
			.form-group input:focus {
				outline: none;
				border-color: var(--drac-green);
				box-shadow: 0 0 0 2px rgba(80, 250, 123, 0.2);
			}
			.form-actions {
				display: flex;
				gap: 12px;
				justify-content: flex-end;
			}
			.cancel-btn {
				padding: 10px 20px;
				border: 1px solid var(--drac-comment);
				border-radius: 8px;
				background: transparent;
				color: var(--drac-foreground);
				cursor: pointer;
				transition: background-color 0.2s, border-color 0.2s;
			}
			.cancel-btn:hover {
				background: rgba(255,255,255,0.1);
				border-color: var(--drac-foreground);
			}
			.save-btn {
				padding: 10px 20px;
				border: none;
				border-radius: 8px;
				background: var(--drac-green);
				color: #111;
				font-weight: 600;
				cursor: pointer;
				transition: background-color 0.2s;
			}
			.save-btn:hover {
				background: #50fa7b;
			}
			.save-btn:disabled {
				background: var(--drac-comment);
				cursor: not-allowed;
			}
			
			/* Notification Bell Styles */
			.notification-bell:hover div {
				background: rgba(255,255,255,0.2) !important;
				transform: scale(1.05);
			}
			
			.notification-bell * {
				pointer-events: none;
			}
			
			.notification-badge {
				animation: pulse 2s infinite;
			}
			
			@keyframes pulse {
				0% { transform: scale(1); }
				50% { transform: scale(1.1); }
				100% { transform: scale(1); }
			}
			
			/* Disabled Navigation Links */
			.nav-link-disabled {
				opacity: 0.5;
				cursor: not-allowed;
				position: relative;
			}
			
			.nav-link-disabled:hover {
				background: rgba(255,255,255,0.05);
				opacity: 0.5;
			}
			
			.nav-link-disabled::after {
				content: "🔒";
				position: absolute;
				right: 10px;
				top: 50%;
				transform: translateY(-50%);
				font-size: 12px;
				opacity: 0.7;
			}
			
			/* Notifications Modal Styles */
			.notifications-modal {
				display: flex;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.7);
				z-index: 1300;
				align-items: center;
				justify-content: center;
				opacity: 0;
				transition: opacity 0.3s ease;
			}
			.notifications-modal.show {
				opacity: 1;
			}
			.notifications-content {
				background: var(--drac-card);
				border: 1px solid var(--drac-comment);
				border-radius: 12px;
				box-shadow: 0 20px 40px rgba(0,0,0,0.5);
				max-width: 500px;
				width: 90%;
				max-height: 80vh;
				overflow-y: auto;
				transform: scale(0.9);
				transition: transform 0.3s ease;
			}
			.notifications-modal.show .notifications-content {
				transform: scale(1);
			}
			.notifications-header {
				padding: 20px 24px;
				border-bottom: 1px solid var(--drac-comment);
				display: flex;
				align-items: center;
				justify-content: space-between;
			}
			.notifications-header h3 {
				margin: 0;
				color: var(--drac-foreground);
				font-weight: 700;
			}
			.clear-notifications-btn {
				transition: all 0.2s;
			}
			.clear-notifications-btn:hover {
				background: rgba(255,255,255,0.1);
				border-color: var(--drac-foreground);
			}
			.notification-item {
				padding: 16px 24px;
				border-bottom: 1px solid var(--drac-comment);
				transition: background-color 0.2s;
				cursor: pointer;
			}
			.notification-item:hover {
				background: rgba(255,255,255,0.05);
			}
			.notification-item:last-child {
				border-bottom: none;
			}
			.notification-item.unread {
				background: rgba(80, 250, 123, 0.05);
				border-left: 4px solid var(--drac-green);
			}
			.notification-title {
				font-weight: 600;
				color: var(--drac-foreground);
				margin: 0 0 4px 0;
				font-size: 14px;
			}
			.notification-message {
				color: var(--drac-comment);
				margin: 0 0 8px 0;
				font-size: 13px;
				line-height: 1.4;
			}
			.notification-time {
				color: var(--drac-comment);
				font-size: 11px;
			}
			.notification-type-badge {
				display: inline-block;
				padding: 2px 8px;
				border-radius: 12px;
				font-size: 10px;
				font-weight: 600;
				text-transform: uppercase;
				margin-left: 8px;
			}
			.notification-type-message {
				background: rgba(74, 222, 128, 0.15);
				color: #4ade80;
			}
			.notification-type-appointment {
				background: rgba(102, 126, 234, 0.15);
				color: #667eea;
			}
			.notification-type-report {
				background: rgba(255, 184, 108, 0.15);
				color: #ffb86c;
			}
			.notification-type-meeting {
				background: rgba(255, 107, 157, 0.15);
				color: #ff6b9d;
			}
		</style>
	</header>

	{% with messages = get_flashed_messages(with_categories=true) %} {% if
	messages %}
	<ul class="flash-messages">
		{% for category, message in messages %}
		<li class="flash-{{ category }}">{{ message }}</li>
		{% endfor %}
	</ul>
	{% endif %} {% endwith %} {% block content %}{% endblock %}
</div>

<!-- Notifications Modal -->
<div id="notificationsModal" class="notifications-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1300; align-items: center; justify-content: center;">
	<div class="notifications-content" style="background: var(--drac-card); border: 1px solid var(--drac-comment); border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
		<div class="notifications-header" style="padding: 20px 24px; border-bottom: 1px solid var(--drac-comment); display: flex; align-items: center; justify-content: space-between;">
			<h3 style="margin: 0; color: var(--drac-foreground); font-weight: 700;">🔔 Notifications</h3>
			<div style="display: flex; gap: 8px;">
				<button id="clearAllNotifications" class="clear-notifications-btn" style="background: none; border: 1px solid var(--drac-comment); border-radius: 6px; color: var(--drac-foreground); padding: 6px 12px; font-size: 12px; cursor: pointer; transition: all 0.2s;">Clear All</button>
				<button id="closeNotificationsModal" class="close-modal-btn" style="background: none; border: none; color: var(--drac-comment); font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s;">×</button>
			</div>
		</div>
		<div id="notificationsContent" class="notifications-list" style="padding: 0;">
			<div class="loading-notification" style="padding: 40px; text-align: center; color: var(--drac-comment);">
				Loading notifications...
			</div>
		</div>
	</div>
</div>

<!-- popup and submenu moved inside navbar above -->

<script>
	const toggle = document.getElementById('theme-toggle');
	const root = document.documentElement;

	// 1️⃣ Load from localStorage or system preference
	const userPreference = localStorage.getItem('theme');
	const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

	if (userPreference) {
		root.setAttribute('data-theme', userPreference);
		toggle.checked = userPreference === 'dark';
	} else if (systemDark) {
		root.setAttribute('data-theme', 'dark');
		toggle.checked = true;
	} else {
		root.setAttribute('data-theme', 'light');
		toggle.checked = false;
	}

	toggle.addEventListener('change', () => {
		const newTheme = toggle.checked ? 'dark' : 'light';
		root.setAttribute('data-theme', newTheme);
		localStorage.setItem('theme', newTheme);
	});

// Global notification function - available immediately
window.toggleNotifications = function() {
	console.log('toggleNotifications called');
	const notificationsModal = document.getElementById('notificationsModal');
	if (!notificationsModal) {
		console.log('Modal not found!');
		return;
	}
	console.log('Modal found, current display:', notificationsModal.style.display);
	
	// Check if modal is already open
	if (notificationsModal.classList.contains('show')) {
		console.log('Modal already open, closing...');
		closeNotificationsModalFunc();
		return;
	}
	
	// Store current scroll position
	const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
	document.body.dataset.scrollTop = scrollTop;
	
	// Show modal immediately
	notificationsModal.style.display = 'flex';
	notificationsModal.style.opacity = '1';
	notificationsModal.classList.add('show');
	
	// Prevent body scroll
	document.body.style.overflow = 'hidden';
	document.body.style.position = 'fixed';
	document.body.style.top = `-${scrollTop}px`;
	document.body.style.width = '100%';
	
	console.log('Modal should be visible now');
	
	// Load notifications when available
	if (typeof loadNotifications === 'function') {
		loadNotifications();
	}
	
	// Reset unread count when available
	if (typeof resetNotificationCount === 'function') {
		resetNotificationCount();
	}
};

document.addEventListener('DOMContentLoaded', () => {
	const profileName = document.querySelector('.profile-name');
	const statusPopup = document.getElementById('statusPopupSidebar');
	const statusSubmenu = document.getElementById('statusSubmenu');
	const profileSection = document.querySelector('.profile-section');
	const currentStatusRow = document.getElementById('currentStatusRow');
	const currentStatusText = document.getElementById('currentStatusText');
	const currentStatusMeta = document.getElementById('currentStatusMeta');
	const currentStatusDot = document.getElementById('currentStatusDot');

	// Header elements
	const headerProfile = document.querySelector('.header-profile');
	const statusPopupHeader = document.getElementById('statusPopupHeader');
	const statusDropdownHeader = document.getElementById('statusDropdownHeader');
	const currentStatusRowHeader = document.getElementById('currentStatusRowHeader');
	const currentStatusTextHeader = document.getElementById('currentStatusTextHeader');
	const currentStatusMetaHeader = document.getElementById('currentStatusMetaHeader');
	const currentStatusDotHeader = document.getElementById('currentStatusDotHeader');

	function togglePopup() {
		if (!statusPopup) return; // Guard against null
		if (statusPopup.dataset.open === 'true') {
			statusPopup.style.maxHeight = '0px';
			statusPopup.style.opacity = '0';
			statusPopup.dataset.open = 'false';
		} else {
			statusPopup.style.maxHeight = '600px';
			statusPopup.style.opacity = '1';
			statusPopup.dataset.open = 'true';
			refreshStatus();
		}
	}

	if (profileName) {
		profileName.style.cursor = 'pointer';
		profileName.addEventListener('click', (e) => {
			e.stopPropagation();
			togglePopup();
		});
	}

	// Make header profile avatar and name both open the header popup
	const profileAvatar = document.querySelector('.profile-avatar');
	if (profileAvatar) {
		profileAvatar.style.cursor = 'pointer';
		profileAvatar.addEventListener('click', (e) => {
			e.stopPropagation();
			togglePopupHeader();
		});
	}
	if (profileName) {
		profileName.addEventListener('click', (e) => {
			e.stopPropagation();
			togglePopupHeader();
		});
	}

	// Header: toggle popup
	function togglePopupHeader() {
		if (!statusPopupHeader) return;
		const open = statusPopupHeader.dataset.open === 'true';
		if (open) {
			statusPopupHeader.style.maxHeight = '0px';
			statusPopupHeader.style.opacity = '0';
		} else {
			statusPopupHeader.style.maxHeight = '600px';
			statusPopupHeader.style.opacity = '1';
		}
		statusPopupHeader.dataset.open = open ? 'false' : 'true';
		refreshStatusHeader();
	}

	if (headerProfile) {
		headerProfile.addEventListener('click', (e) => {
			e.stopPropagation();
			togglePopupHeader();
		});
	}

	document.addEventListener('click', (e) => {
		// Close sidebar popup if clicking outside (only if sidebar exists)
		if (statusPopup && statusSubmenu && !statusPopup.contains(e.target) && e.target !== profileName && !statusSubmenu.contains(e.target)) {
			statusPopup.style.maxHeight = '0px';
			statusPopup.style.opacity = '0';
			statusPopup.dataset.open = 'false';
			statusSubmenu.style.display = 'none';
		}
		// Close header popup if clicking outside
		if (statusPopupHeader && !statusPopupHeader.contains(e.target) && !headerProfile?.contains(e.target)) {
			statusPopupHeader.style.maxHeight = '0px';
			statusPopupHeader.style.opacity = '0';
			statusPopupHeader.dataset.open = 'false';
			// Close dropdown with same logic as toggle
			if (statusDropdownHeader) {
				statusDropdownHeader.style.maxHeight = '0px';
				statusDropdownHeader.style.padding = '0';
				statusDropdownHeader.style.marginTop = '0';
				dropdownExpanded = false;
				// Reset arrow
				const arrow = currentStatusRowHeader?.querySelector('.status-arrow');
				if (arrow) arrow.style.transform = 'rotate(90deg)';
			}
		}
	});

	async function postStatus(status) {
		const formData = new FormData();
		formData.append('status', status);
		
		const res = await fetch('/doctor/status', {
			method: 'POST',
			body: formData
		});
		
		if (res.redirected) {
			// Success - page will redirect, just return success
			return { ok: true };
		}
		
		// If not redirected, try to parse as JSON for error handling
		try {
			const data = await res.json();
			if (!res.ok) throw new Error(data.error || 'Failed to update');
			return data;
		} catch (e) {
			if (res.ok) {
				// If response is OK but not JSON, treat as success
				return { ok: true };
			}
			throw new Error('Failed to update status');
		}
	}

	async function refreshStatus() {
		if (!currentStatusText || !currentStatusMeta || !currentStatusDot) return; // Guard against null
		try {
			const res = await fetch('/api/doctor/status');
			const json = await res.json();
			const s = (json.status || 'available').toLowerCase();
			currentStatusText.textContent = s.charAt(0).toUpperCase() + s.slice(1);
			currentStatusMeta.textContent = '';
			let color = 'var(--drac-green)';
			if (s === 'busy') { color = 'var(--drac-orange)'; currentStatusMeta.textContent = json.until ? `until ${json.until}` : ''; }
			if (s === 'emergency') { color = 'var(--drac-red)'; currentStatusMeta.textContent = json.until ? `until ${json.until}` : ''; }
			currentStatusDot.style.background = color;
		} catch(e) { /* ignore */ }
	}

	async function refreshStatusHeader() {
		if (!currentStatusTextHeader || !currentStatusMetaHeader || !currentStatusDotHeader) return;
		try {
			const res = await fetch('/api/doctor/status');
			const json = await res.json();
			const s = (json.status || 'available').toLowerCase();
			currentStatusTextHeader.textContent = s.charAt(0).toUpperCase() + s.slice(1);
			currentStatusMetaHeader.textContent = '';
			let color = 'var(--drac-green)';
			if (s === 'busy') { color = 'var(--drac-orange)'; currentStatusMetaHeader.textContent = json.until ? `until ${json.until}` : ''; }
			if (s === 'emergency') { color = 'var(--drac-red)'; currentStatusMetaHeader.textContent = json.until ? `until ${json.until}` : ''; }
			currentStatusDotHeader.style.background = color;
		} catch(e) { /* ignore */ }
	}

	function positionSubmenu() {
		if (!statusPopup || !currentStatusRow || !statusSubmenu) return; // Guard against null
		const sidebar = document.querySelector('.sidebar');
		const profileSection = document.querySelector('.profile-section');
		if (!sidebar || !profileSection) return; // Guard against missing elements
		
		const popupRect = statusPopup.getBoundingClientRect();
		const rowRect = currentStatusRow.getBoundingClientRect();
		const sidebarRect = sidebar.getBoundingClientRect();
		const profileRect = profileSection.getBoundingClientRect();
		
		// temporarily display to measure dimensions
		statusSubmenu.style.display = 'block';
		const submenuWidth = statusSubmenu.offsetWidth;
		const submenuHeight = statusSubmenu.offsetHeight;
		statusSubmenu.style.display = 'none';
		
		// Position relative to the profile section (parent container)
		// Align to the right of the sidebar/popup
		let left = sidebarRect.width - profileRect.left + 8;
		let top = popupRect.top - profileRect.top + (rowRect.top - popupRect.top);
		
		// Check if submenu would overflow the viewport to the right
		if (sidebarRect.right + submenuWidth + 8 > window.innerWidth) {
			// Position to the left of the sidebar instead
			left = -submenuWidth - 8;
		}
		
		// Ensure submenu doesn't overflow bottom
		const maxTop = popupRect.height - submenuHeight;
		if (top > maxTop && maxTop > 0) {
			top = maxTop;
		}
		
		// Ensure submenu doesn't overflow top
		if (top < (popupRect.top - profileRect.top)) {
			top = popupRect.top - profileRect.top;
		}
		
		statusSubmenu.style.left = `${left}px`;
		statusSubmenu.style.top = `${top}px`;
	}

	// Status option hover effects
	if (statusDropdownHeader) {
		statusDropdownHeader.querySelectorAll('.status-option').forEach(option => {
			const statusBg = option.querySelector('.status-bg');
			const indicator = option.querySelector('.status-indicator');
			
			option.addEventListener('mouseenter', () => {
				if (statusBg) statusBg.style.opacity = '1';
				if (indicator) indicator.style.width = '6px';
			});
			option.addEventListener('mouseleave', () => {
				if (statusBg) statusBg.style.opacity = '0';
				if (indicator) indicator.style.width = '4px';
			});
		});
	}

	let submenuHover = false;
	// Only attach sidebar event listeners if elements exist
	if (currentStatusRow && statusSubmenu) {
		currentStatusRow.addEventListener('mouseenter', () => {
			positionSubmenu();
			statusSubmenu.style.display = 'block';
		});
		currentStatusRow.addEventListener('mouseleave', () => {
			setTimeout(() => { if (!submenuHover) statusSubmenu.style.display = 'none'; }, 120);
		});
		statusSubmenu.addEventListener('mouseenter', () => { submenuHover = true; });
		statusSubmenu.addEventListener('mouseleave', () => {
			submenuHover = false;
			statusSubmenu.style.display = 'none';
		});
	}

	let submenuHoverHeader = false;
	let dropdownExpanded = false; // Track dropdown state properly
	if (currentStatusRowHeader) {
		console.log('currentStatusRowHeader found, attaching click handler');
		currentStatusRowHeader.style.cursor = 'pointer';
		currentStatusRowHeader.addEventListener('click', (e) => {
			e.stopPropagation();
			console.log('currentStatusRowHeader clicked, dropdownExpanded:', dropdownExpanded);
			if (statusDropdownHeader) {
				if (dropdownExpanded) {
					console.log('Closing dropdown');
					statusDropdownHeader.style.maxHeight = '0px';
					statusDropdownHeader.style.padding = '0';
					statusDropdownHeader.style.marginTop = '0';
					statusDropdownHeader.style.overflow = 'hidden'; // Ensure content is hidden when closed
					dropdownExpanded = false;
				} else {
					console.log('Opening dropdown');
					statusDropdownHeader.style.maxHeight = '300px';
					statusDropdownHeader.style.padding = '8px 0';
					statusDropdownHeader.style.marginTop = '12px';
					statusDropdownHeader.style.overflow = 'visible';
					dropdownExpanded = true;
				}
				// Rotate arrow
				const arrow = currentStatusRowHeader.querySelector('.status-arrow');
				if (arrow) {
					arrow.style.transform = dropdownExpanded ? 'rotate(270deg)' : 'rotate(90deg)';
				}
			} else {
				console.error('statusDropdownHeader not found!');
			}
		});
	} else {
		console.error('currentStatusRowHeader not found!');
	}

	// Status option click handlers
	if (statusDropdownHeader) {
		const statusOptions = statusDropdownHeader.querySelectorAll('.status-option[data-status]');
		console.log('Found status options:', statusOptions.length);
		statusOptions.forEach(option => {
			option.style.cursor = 'pointer';
			option.addEventListener('click', async (e) => {
				e.stopPropagation();
				const status = option.getAttribute('data-status');
				console.log('Status option clicked:', status);
				try {
					await postStatus(status);
					// Send message to update all status displays
					window.postMessage({
						type: 'doctor_status_update',
						status: status,
						set_at: new Date().toISOString(),
						expires_at: status === 'busy' ? new Date(Date.now() + 60 * 60 * 1000).toISOString() : 
									status === 'emergency' ? new Date(Date.now() + 3 * 60 * 60 * 1000).toISOString() : null
					}, '*');
					statusPopupHeader.style.maxHeight = '0px';
					statusPopupHeader.style.opacity = '0';
					statusPopupHeader.dataset.open = 'false';
					// Close dropdown with animation
					statusDropdownHeader.style.maxHeight = '0px';
					statusDropdownHeader.style.padding = '0';
					statusDropdownHeader.style.marginTop = '0';
					statusDropdownHeader.style.overflow = 'hidden'; // Ensure content is hidden when closed
					dropdownExpanded = false; // Reset state
					// Reset arrow
					const arrow = currentStatusRowHeader.querySelector('.status-arrow');
					if (arrow) arrow.style.transform = 'rotate(90deg)';
				} catch (e) {
					console.error('Error updating status:', e);
					// Show error to user
					alert('Failed to update status. Please try again.');
				}
			});
		});
	}

	// Click handlers for statuses in submenu
	if (statusSubmenu) {
		statusSubmenu.querySelectorAll('[data-status]').forEach(btn => {
			btn.addEventListener('click', async () => {
				const status = btn.getAttribute('data-status');
				try {
					await postStatus(status);
					// Send message to update all status displays
					window.postMessage({
						type: 'doctor_status_update',
						status: status,
						set_at: new Date().toISOString(),
						expires_at: status === 'busy' ? new Date(Date.now() + 60 * 60 * 1000).toISOString() : 
								status === 'emergency' ? new Date(Date.now() + 3 * 60 * 60 * 1000).toISOString() : null
				}, '*');
				statusPopup.style.maxHeight = '0px';
				statusPopup.style.opacity = '0';
				statusPopup.dataset.open = 'false';
				statusSubmenu.style.display = 'none';
			} catch (e) {
				console.error('Error updating status:', e);
				alert('Failed to update status. Please try again.');
			}
		});
	});
	}

	// Listen for status updates from dashboard
	window.addEventListener('message', (event) => {
		if (event.data && event.data.type === 'doctor_status_update') {
			// Update header status displays
			refreshStatusHeader();
			// Also update dashboard status bar if it exists
			const dashboardStatus = document.getElementById('currentStatus');
			if (dashboardStatus) {
				const status = (event.data.status || 'available').toLowerCase();
				dashboardStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
				dashboardStatus.className = `status-text status-${status}`;
			}
		}
	});

	// Edit Profile Modal functionality
	const editProfileBtn = document.getElementById('editProfileBtn');
	const editProfileModal = document.getElementById('editProfileModal');
	const closeEditProfileModal = document.getElementById('closeEditProfileModal');
	const cancelEditProfile = document.getElementById('cancelEditProfile');
	const editProfileForm = document.getElementById('editProfileForm');

	function openEditProfileModal() {
		if (editProfileModal) {
			editProfileModal.style.display = 'flex';
			// Trigger reflow for animation
			editProfileModal.offsetHeight;
			editProfileModal.classList.add('show');
			document.body.style.overflow = 'hidden'; // Prevent background scrolling
		}
	}

	function closeEditProfileModalFunc() {
		if (editProfileModal) {
			editProfileModal.classList.remove('show');
			setTimeout(() => {
				editProfileModal.style.display = 'none';
			}, 300); // Match transition duration
			document.body.style.overflow = ''; // Restore scrolling
		}
	}

	if (editProfileBtn) {
		editProfileBtn.addEventListener('click', (e) => {
			e.preventDefault();
			e.stopPropagation();
			openEditProfileModal();
		});
	}

	if (closeEditProfileModal) {
		closeEditProfileModal.addEventListener('click', closeEditProfileModalFunc);
	}

	if (cancelEditProfile) {
		cancelEditProfile.addEventListener('click', closeEditProfileModalFunc);
	}

	// Close modal when clicking outside
	if (editProfileModal) {
		editProfileModal.addEventListener('click', (e) => {
			if (e.target === editProfileModal) {
				closeEditProfileModalFunc();
			}
		});
	}

	// Handle form submission
	if (editProfileForm) {
		editProfileForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			
			const formData = new FormData(editProfileForm);
			
			try {
				const response = await fetch('/api/doctor/profile', {
					method: 'POST',
					body: formData
				});
				
				if (response.ok) {
					const result = await response.json();
					// Close modal
					closeEditProfileModalFunc();
					// Show success message
					alert(result.message || 'Profile updated successfully!');
					// Refresh the page to show updated profile info
					window.location.reload();
				} else {
					const error = await response.json();
					alert('Error updating profile: ' + (error.message || 'Unknown error'));
				}
			} catch (error) {
				console.error('Error updating profile:', error);
				alert('Error updating profile. Please try again.');
			}
		});
	}
	
	// ===== NOTIFICATION SYSTEM =====
	
	// Notification elements
	const notificationBadge = document.getElementById('notificationBadge');
	const notificationsModal = document.getElementById('notificationsModal');
	const closeNotificationsModal = document.getElementById('closeNotificationsModal');
	const clearAllNotificationsBtn = document.getElementById('clearAllNotifications');
	const notificationsContent = document.getElementById('notificationsContent');
	
	// Support functions for global toggleNotifications
	window.loadNotifications = loadNotifications;
	window.resetNotificationCount = resetNotificationCount;
	
	function closeNotificationsModalFunc() {
		const notificationsModal = document.getElementById('notificationsModal');
		if (notificationsModal) {
			console.log('Closing notifications modal...');
			notificationsModal.classList.remove('show');
			
			// Restore scroll position
			const scrollTop = document.body.dataset.scrollTop || 0;
			document.body.style.overflow = '';
			document.body.style.position = '';
			document.body.style.top = '';
			document.body.style.width = '';
			window.scrollTo(0, parseInt(scrollTop));
			
			setTimeout(() => {
				notificationsModal.style.display = 'none';
			}, 300);
		}
	}
	
	// Make close function globally available
	window.closeNotificationsModalFunc = closeNotificationsModalFunc;
	
	if (closeNotificationsModal) {
		closeNotificationsModal.addEventListener('click', closeNotificationsModalFunc);
	}
	
	if (clearAllNotificationsBtn) {
		clearAllNotificationsBtn.addEventListener('click', clearAllNotifications);
	}
	
	// Close modal when clicking outside
	if (notificationsModal) {
		notificationsModal.addEventListener('click', (e) => {
			if (e.target === notificationsModal) {
				closeNotificationsModalFunc();
			}
		});
	}
	
	async function loadNotifications() {
		try {
			// For doctors, load notifications created by patient activities
			const response = await fetch('/api/notifications?limit=50&patient_created=true');
			const data = await response.json();
			
			displayNotifications(data.notifications);
		} catch (error) {
			console.error('Error loading notifications:', error);
			notificationsContent.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--drac-comment);">Error loading notifications</div>';
		}
	}
	
	function displayNotifications(notifications) {
		if (!notifications || notifications.length === 0) {
			notificationsContent.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--drac-comment);">No patient notifications yet</div>';
			return;
		}
		
		const notificationHtml = notifications.map(notification => {
			const timeAgo = getTimeAgo(notification.created_at);
			const isUnread = notification.read_status === 0;
			
			// Add patient context if available
			let patientInfo = '';
			if (notification.creator_name) {
				patientInfo = `<div class="notification-patient" style="font-size: 12px; color: var(--drac-comment); margin-top: 4px;">From: ${notification.creator_name}</div>`;
			}
			
			return `
				<div class="notification-item ${isUnread ? 'unread' : ''}" onclick="markAsRead(${notification.id})">
					<div class="notification-title">
						${notification.title}
						<span class="notification-type-badge notification-type-${notification.type}">${notification.type}</span>
					</div>
					<div class="notification-message">${notification.message}</div>
					${patientInfo}
					<div class="notification-time">${timeAgo}</div>
				</div>
			`;
		}).join('');
		
		notificationsContent.innerHTML = notificationHtml;
	}
	
	window.markAsRead = async function(notificationId) {
		try {
			await fetch(`/api/notifications/${notificationId}/read`, { method: 'POST' });
			// Reload notifications to update read status
			loadNotifications();
		} catch (error) {
			console.error('Error marking notification as read:', error);
		}
	};
	
	function getTimeAgo(dateString) {
		const now = new Date();
		const date = new Date(dateString);
		const diffInSeconds = Math.floor((now - date) / 1000);
		
		if (diffInSeconds < 60) return 'Just now';
		if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
		if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
		return `${Math.floor(diffInSeconds / 86400)}d ago`;
	}
	
	async function updateNotificationBadge() {
		console.log('updateNotificationBadge called');
		console.log('notificationBadge:', notificationBadge);
		try {
			const response = await fetch('/api/notifications/unread-count');
			console.log('API response status:', response.status);
			const data = await response.json();
			console.log('API response data:', data);
			const count = data.unread_count;
			
			if (count > 0) {
				notificationBadge.textContent = count > 99 ? '99+' : count;
				notificationBadge.style.display = 'flex';
				console.log('Badge updated, count:', count);
			} else {
				notificationBadge.style.display = 'none';
				console.log('Badge hidden, count is 0');
			}
		} catch (error) {
			console.error('Error updating notification badge:', error);
		}
	}
	
	async function resetNotificationCount() {
		try {
			// Mark all unread notifications as read
			const response = await fetch('/api/notifications?unread_only=true');
			const data = await response.json();
			
			// Mark each unread notification as read
			const promises = data.notifications.map(notification => 
				fetch(`/api/notifications/${notification.id}/read`, { method: 'POST' })
			);
			
			await Promise.all(promises);
			
			// Update badge
			updateNotificationBadge();
		} catch (error) {
			console.error('Error resetting notification count:', error);
		}
	}
	
	async function clearAllNotifications() {
		try {
			const response = await fetch('/api/notifications/clear-all', { 
				method: 'DELETE',
				headers: {
					'Content-Type': 'application/json'
				}
			});
			
			if (response.ok) {
				// Reload notifications
				loadNotifications();
				
				// Update badge
				updateNotificationBadge();
			} else {
				console.error('Failed to clear notifications');
			}
		} catch (error) {
			console.error('Error clearing notifications:', error);
		}
	}
	
	// Initialize notification badge on page load
	updateNotificationBadge();
	
	// Update notification badge every 30 seconds
	setInterval(updateNotificationBadge, 30000);
});
</script>

{% endblock %}

<!-- header logout handled via anchor link to /logout -->
